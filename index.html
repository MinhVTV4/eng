<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI English Quiz - Luy·ªán T·∫≠p To√†n Di·ªán</title>
    <!-- T√≠ch h·ª£p Tailwind CSS ƒë·ªÉ l√†m giao di·ªán -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }
        .view { display: none; animation: fadeIn 0.5s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #0ea5e9; animation: spin 1s ease-in-out infinite; }
        .btn-spinner { width: 20px; height: 20px; border-width: 3px; border-left-color: white; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #passageText { max-height: 200px; overflow-y: auto; }
        .topic-container { transition: all 0.3s ease-in-out; }
        /* N√ÇNG C·∫§P: CSS cho c·ª≠a s·ªï d·ªãch thu·∫≠t (Modal) */
        #translationModal.hidden { display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 1rem; max-width: 90%; width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; }
        .translate-icon { cursor: pointer; color: #3b82f6; margin-left: 8px; font-size: 1.25rem; display: inline-block; vertical-align: middle; }
        .info-icon { cursor: pointer; background-color: #dbeafe; color: #3b82f6; border-radius: 50%; width: 22px; height: 22px; font-style: normal; font-weight: bold; display: flex; align-items: center; justify-content: center; margin-left: auto; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="appContainer" class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-500">

        <!-- M√†n h√¨nh 0: ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω -->
        <div id="auth-view" class="view active">
            <h1 class="text-3xl font-bold text-center text-sky-600 mb-2">Ch√†o m·ª´ng b·∫°n!</h1>
            <p class="text-center text-slate-500 mb-8">ƒêƒÉng nh·∫≠p ho·∫∑c ƒêƒÉng k√Ω ƒë·ªÉ l∆∞u ti·∫øn tr√¨nh h·ªçc</p>
            <div class="space-y-4">
                <div><label for="emailInput" class="block text-sm font-medium mb-1 text-slate-700">Email</label><input type="email" id="emailInput" placeholder="ten@email.com" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition"></div>
                <div><label for="passwordInput" class="block text-sm font-medium mb-1 text-slate-700">M·∫≠t kh·∫©u</label><input type="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition"></div>
            </div>
            <p id="authError" class="text-red-500 text-sm text-center mt-4 h-5"></p>
            <div class="mt-6 space-y-3">
                 <button id="loginButton" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-3 disabled:bg-sky-300"><span class="btn-text">ƒêƒÉng nh·∫≠p</span><div class="spinner btn-spinner hidden"></div></button>
                 <button id="registerButton" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-3 disabled:bg-slate-400"><span class="btn-text">ƒêƒÉng k√Ω</span><div class="spinner btn-spinner hidden"></div></button>
            </div>
        </div>

        <!-- M√†n h√¨nh 1: Thi·∫øt l·∫≠p b√†i ki·ªÉm tra -->
        <div id="setup-view" class="view">
            <div class="flex justify-between items-start mb-8">
                 <div><h1 class="text-3xl font-bold text-sky-600">AI English Quiz</h1><p id="welcomeMessage" class="text-slate-500">Ch√†o m·ª´ng tr·ªü l·∫°i!</p></div>
                 <div class="flex flex-col items-end space-y-2">
                    <div id="streakDisplay" class="flex items-center justify-center bg-orange-100 text-orange-600 font-bold text-sm px-3 py-1 rounded-full">
                        <span class="mr-1">üî•</span>
                        <span id="streakCount">0</span>
                    </div>
                    <div class="flex space-x-2">
                        <button id="showHistoryButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">L·ªãch s·ª≠</button>
                        <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">ƒêƒÉng xu·∫•t</button>
                    </div>
                 </div>
            </div>
            <div class="space-y-6">
                <div>
                    <label for="quizTypeSelect" class="block text-lg font-semibold mb-2 text-slate-700">Ch·ªçn k·ªπ nƒÉng luy·ªán t·∫≠p:</label>
                    <select id="quizTypeSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white">
                        <option value="vocabulary" selected>T·ª´ v·ª±ng (Vocabulary)</option>
                        <option value="reading">ƒê·ªçc hi·ªÉu (Reading)</option>
                        <option value="grammar">Ng·ªØ ph√°p (Grammar)</option>
                    </select>
                </div>
                <div id="topicContainer" class="topic-container">
                    <label for="topicSelect" class="block text-lg font-semibold mb-2 text-slate-700">Ch·ªçn ch·ªß ƒë·ªÅ b·∫°n y√™u th√≠ch:</label>
                    <select id="topicSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white">
                        <option value="Travel">Du l·ªãch (Travel)</option>
                        <option value="Technology" selected>C√¥ng ngh·ªá (Technology)</option>
                        <option value="Food & Cooking">·∫®m th·ª±c & N·∫•u ƒÉn (Food & Cooking)</option>
                        <option value="Health & Fitness">S·ª©c kh·ªèe & Th·ªÉ h√¨nh (Health & Fitness)</option>
                        <option value="Work & Business">C√¥ng vi·ªác & Kinh doanh (Work & Business)</option>
                        <option value="Movies & Entertainment">Phim ·∫£nh & Gi·∫£i tr√≠ (Movies & Entertainment)</option>
                        <option value="Music">√Çm nh·∫°c (Music)</option>
                        <option value="Sports">Th·ªÉ thao (Sports)</option>
                        <option value="Education">Gi√°o d·ª•c (Education)</option>
                        <option value="Nature & Environment">Thi√™n nhi√™n & M√¥i tr∆∞·ªùng (Nature & Environment)</option>
                        <option value="History">L·ªãch s·ª≠ (History)</option>
                        <option value="Science">Khoa h·ªçc (Science)</option>
                        <option value="Fashion & Shopping">Th·ªùi trang & Mua s·∫Øm (Fashion & Shopping)</option>
                        <option value="Daily Life">Cu·ªôc s·ªëng h√†ng ng√†y (Daily Life)</option>
                        <option value="Relationships">C√°c m·ªëi quan h·ªá (Relationships)</option>
                    </select>
                </div>
                <div><label for="levelSelect" class="block text-lg font-semibold mb-2 text-slate-700">Ch·ªçn tr√¨nh ƒë·ªô c·ªßa b·∫°n:</label><select id="levelSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white"><option value="A2">A2 (Beginner)</option><option value="B1" selected>B1 (Intermediate)</option><option value="B2">B2 (Upper-Intermediate)</option><option value="C1">C1 (Advanced)</option></select></div>
            </div>
            <button id="startQuizButton" class="mt-10 w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition-transform transform hover:scale-105 flex items-center justify-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path></svg>B·∫Øt ƒë·∫ßu l√†m b√†i</button>
        </div>
        
        <!-- M√†n h√¨nh 1.5: L·ªãch s·ª≠ l√†m b√†i -->
        <div id="history-view" class="view">
            <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-bold text-indigo-600">L·ªãch s·ª≠ l√†m b√†i</h2><button id="backToSetupFromHistory" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Quay l·∫°i</button></div>
            <div id="historyList" class="space-y-4 max-h-96 overflow-y-auto pr-2"></div>
        </div>

        <!-- M√†n h√¨nh 2: ƒêang t·∫£i c√¢u h·ªèi -->
        <div id="loading-view" class="view text-center py-16">
            <div class="spinner mx-auto mb-6"></div><h2 class="text-2xl font-semibold text-slate-700">ƒêang t·∫°o b√†i ki·ªÉm tra...</h2><p class="text-slate-500">AI ƒëang chu·∫©n b·ªã c√°c c√¢u h·ªèi v·ªÅ ch·ªß ƒë·ªÅ <b id="loadingTopic"></b> cho b·∫°n. Vui l√≤ng ch·ªù!</p>
        </div>

        <!-- M√†n h√¨nh 3: L√†m b√†i ki·ªÉm tra -->
        <div id="quiz-view" class="view">
            <div class="flex justify-between items-center mb-4"><div id="progress" class="text-lg font-semibold text-slate-600">C√¢u 1 / 5</div><div id="score" class="text-lg font-bold text-sky-600">ƒêi·ªÉm: 0</div></div>
            <div class="w-full bg-slate-200 rounded-full h-2.5 mb-8"><div id="progressBar" class="bg-sky-500 h-2.5 rounded-full" style="width: 20%"></div></div>
            <div id="passageContainer" class="mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200 hidden"><p id="passageText"></p></div>
            <div id="questionContainer" class="mb-6">
                <p class="text-xl md:text-2xl font-semibold leading-relaxed mb-6">
                    <span id="questionText"></span>
                    <!-- N√ÇNG C·∫§P: N√∫t d·ªãch c√¢u h·ªèi -->
                    <span id="translateQuestionBtn" class="translate-icon" title="D·ªãch c√¢u h·ªèi n√†y">üåê</span>
                </p>
                <div id="optionsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div id="feedbackContainer" class="mt-6 p-4 rounded-lg min-h-[100px]"></div>
            <button id="nextQuestionButton" class="hidden mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition">Ti·∫øp t·ª•c</button>
        </div>

        <!-- M√†n h√¨nh 4: K·∫øt qu·∫£ -->
        <div id="result-view" class="view text-center">
            <h2 class="text-3xl font-bold text-slate-800 mb-2">Ho√†n th√†nh!</h2><p class="text-slate-500 text-lg mb-6">ƒê√¢y l√† k·∫øt qu·∫£ c·ªßa b·∫°n:</p>
            <div class="bg-sky-100 border-2 border-sky-300 rounded-xl p-8 mb-8"><p class="text-2xl font-semibold mb-2">T·ªïng ƒëi·ªÉm</p><p id="finalScore" class="text-6xl font-bold text-sky-600">4 / 5</p></div>
            <p id="resultMessage" class="text-lg mb-8"></p>
            <div class="flex space-x-4"><button id="playAgainButton" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition">L√†m l·∫°i</button><button id="viewHistoryFromResultButton" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition">Xem l·ªãch s·ª≠</button></div>
        </div>
        
        <!-- Th√¥ng b√°o l·ªói chung -->
        <div id="error-view" class="view text-center text-red-600 bg-red-100 p-6 rounded-lg">
             <h2 class="text-2xl font-bold mb-4">ƒê√£ x·∫£y ra l·ªói</h2><p id="errorMessage" class="mb-6"></p><button id="backToSetupButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg">Quay l·∫°i</button>
        </div>
    </div>
    
    <!-- N√ÇNG C·∫§P: Modal hi·ªÉn th·ªã b·∫£n d·ªãch -->
    <div id="translationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-slate-800 mb-4">B·∫£n d·ªãch</h3>
            <div id="translationResult" class="bg-slate-100 p-4 rounded-lg min-h-[80px]">
                <div class="spinner mx-auto"></div>
            </div>
            <button id="closeTranslationModal" class="mt-6 w-full bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg">ƒê√≥ng</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDgEH2E7W-ltp0IJwYSOjjSitB7xQhI11E",
            authDomain: "engai-374f7.firebaseapp.com",
            projectId: "engai-374f7",
            storageBucket: "engai-374f7.firebasestorage.app",
            messagingSenderId: "793685525357",
            appId: "1:793685525357:web:bf74f624247165fd53d064"
        };

        let app, auth, model, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { model: "gemini-1.5-flash" });
        } catch(e) { showError(`L·ªói kh·ªüi t·∫°o: ${e.message}.`); }

        const welcomeMessage = document.getElementById('welcomeMessage'), emailInput = document.getElementById('emailInput'), passwordInput = document.getElementById('passwordInput'), loginButton = document.getElementById('loginButton'), registerButton = document.getElementById('registerButton'), logoutButton = document.getElementById('logoutButton'), authError = document.getElementById('authError'), quizTypeSelect = document.getElementById('quizTypeSelect'), topicContainer = document.getElementById('topicContainer'), topicSelect = document.getElementById('topicSelect'), levelSelect = document.getElementById('levelSelect'), startQuizButton = document.getElementById('startQuizButton'), showHistoryButton = document.getElementById('showHistoryButton'), historyList = document.getElementById('historyList'), backToSetupFromHistory = document.getElementById('backToSetupFromHistory'), loadingTopic = document.getElementById('loadingTopic'), progress = document.getElementById('progress'), scoreEl = document.getElementById('score'), progressBar = document.getElementById('progressBar'), passageContainer = document.getElementById('passageContainer'), passageText = document.getElementById('passageText'), questionText = document.getElementById('questionText'), translateQuestionBtn = document.getElementById('translateQuestionBtn'), optionsContainer = document.getElementById('optionsContainer'), feedbackContainer = document.getElementById('feedbackContainer'), nextQuestionButton = document.getElementById('nextQuestionButton'), playAgainButton = document.getElementById('playAgainButton'), viewHistoryFromResultButton = document.getElementById('viewHistoryFromResultButton'), finalScore = document.getElementById('finalScore'), resultMessage = document.getElementById('resultMessage'), errorMessage = document.getElementById('errorMessage'), backToSetupButton = document.getElementById('backToSetupButton'), streakCount = document.getElementById('streakCount'), translationModal = document.getElementById('translationModal'), translationResult = document.getElementById('translationResult'), closeTranslationModal = document.getElementById('closeTranslationModal');

        let quizData = {};
        let currentQuestionIndex = 0;
        let score = 0;

        async function updateUserStreak(userId) {
            const userRef = doc(db, "users", userId);
            const today = new Date().toISOString().slice(0, 10);
            try {
                const userDoc = await getDoc(userRef);
                let currentStreak = 0; let lastActivityDate = '';
                if (userDoc.exists()) { const userData = userDoc.data(); currentStreak = userData.currentStreak || 0; lastActivityDate = userData.lastActivityDate || ''; }
                if (lastActivityDate === today) { streakCount.textContent = currentStreak; return; }
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().slice(0, 10);
                if (lastActivityDate === yesterdayStr) { currentStreak++; } else { currentStreak = 1; }
                await setDoc(userRef, { lastActivityDate: today, currentStreak: currentStreak }, { merge: true });
                streakCount.textContent = currentStreak;
            } catch (error) { console.error("Error updating streak:", error); }
        }

        onAuthStateChanged(auth, user => {
            if (user) { welcomeMessage.textContent = `Ch√†o m·ª´ng, ${user.email}!`; updateUserStreak(user.uid); showView('setup-view'); } 
            else { showView('auth-view'); }
        });
        const handleAuthAction = async (action) => {
            const email = emailInput.value, password = passwordInput.value; authError.textContent = '';
            if (!email || !password) { authError.textContent = 'Vui l√≤ng nh·∫≠p ƒë·ªß email v√† m·∫≠t kh·∫©u.'; return; }
            const button = action === 'login' ? loginButton : registerButton, otherButton = action === 'login' ? registerButton : loginButton;
            const buttonText = button.querySelector('.btn-text'), spinner = button.querySelector('.spinner');
            buttonText.textContent = action === 'login' ? 'ƒêang ƒëƒÉng nh·∫≠p...' : 'ƒêang ƒëƒÉng k√Ω...';
            spinner.classList.remove('hidden'); button.disabled = true; otherButton.disabled = true;
            try {
                if (action === 'login') { await signInWithEmailAndPassword(auth, email, password); } 
                else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", userCredential.user.uid), { email: userCredential.user.email, createdAt: serverTimestamp(), currentStreak: 0, lastActivityDate: '' });
                }
            } catch (error) { authError.textContent = getFriendlyAuthError(error.code); } 
            finally {
                buttonText.textContent = action === 'login' ? 'ƒêƒÉng nh·∫≠p' : 'ƒêƒÉng k√Ω';
                spinner.classList.add('hidden'); button.disabled = false; otherButton.disabled = false;
            }
        };
        const handleLogout = async () => { try { await signOut(auth); } catch (error) { showError("ƒêƒÉng xu·∫•t th·∫•t b·∫°i."); }};
        function getFriendlyAuthError(c) { switch (c) { case 'auth/invalid-email': return 'Email kh√¥ng h·ª£p l·ªá.'; case 'auth/user-not-found': case 'auth/wrong-password': return 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.'; case 'auth/email-already-in-use': return 'Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.'; case 'auth/weak-password': return 'M·∫≠t kh·∫©u qu√° y·∫øu.'; default: return 'L·ªói x√°c th·ª±c.'; } }

        function showView(viewId) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(viewId).classList.add('active'); }
        function showError(msg) { errorMessage.textContent = msg; showView('error-view'); }

        function extractAndParseQuizJson(rawText) {
            const quizRegex = /```json\s*([\s\S]*?)\s*```/;
            const match = rawText.match(quizRegex);
            let jsonString = (match && match[1]) ? match[1] : rawText;
            jsonString = jsonString.replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F]/g, '');
            try { return JSON.parse(jsonString); } 
            catch (error) { console.error("JSON Parse Error:", error, "String:", jsonString); return null; }
        }

        // N√ÇNG C·∫§P: H√†m d·ªãch thu·∫≠t chung
        async function getTranslation(text) {
            try {
                const prompt = `Translate the following English text to Vietnamese. Provide only the Vietnamese translation, without any extra text or quotation marks: "${text}"`;
                const result = await model.generateContent(prompt);
                return result.response.text();
            } catch (error) {
                console.error("Translation error:", error);
                return "Kh√¥ng th·ªÉ d·ªãch ƒë∆∞·ª£c.";
            }
        }

        function showTranslationModal(textPromise) {
            translationModal.classList.remove('hidden');
            translationResult.innerHTML = '<div class="spinner mx-auto"></div>';
            textPromise.then(translatedText => {
                translationResult.innerHTML = `<p class="text-lg">${translatedText}</p>`;
            });
        }

        function getVocabularyPrompt(level, topic, count) { return `You are an expert English teacher. Generate ${count} multiple-choice vocabulary questions for an English learner at the ${level} CEFR level. The topic is "${topic}". Provide one correct answer, three plausible distractors, and a brief, helpful explanation IN VIETNAMESE. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects: \`\`\`json\n[ { "question": "...", "options": [...], "answer": "...", "explanation": "..." } ]\n\`\`\``; }
        function getReadingPrompt(level, topic, count) { return `You are an expert English teacher. Create a reading comprehension quiz. Generate one short reading passage (about 100-150 words) and ${count} multiple-choice questions about it. The passage topic is "${topic}" and it should be suitable for a ${level} CEFR level learner. For each question, provide one correct answer, three plausible distractors, and a brief, helpful explanation IN VIETNAMESE. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON object: \`\`\`json\n{ "passage": "...", "questions": [ { "question": "...", "options": [...], "answer": "...", "explanation": "..." } ] }\n\`\`\``; }
        function getGrammarPrompt(level, count) { return `You are an expert English grammar teacher. Generate ${count} multiple-choice grammar questions for an English learner at the ${level} CEFR level. Each question should test a common grammar point (e.g., tenses, prepositions, articles, modals). Provide one correct answer, three plausible distractors, and a brief, helpful explanation IN VIETNAMESE that clearly explains the grammar rule. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects: \`\`\`json\n[ { "question": "...", "options": [...], "answer": "...", "explanation": "..." } ]\n\`\`\``; }

        async function startQuiz() {
            const quizType = quizTypeSelect.value;
            const topic = quizType !== 'grammar' ? topicSelect.value : 'Grammar';
            const level = levelSelect.value;

            quizData = { topic, level, quizType };
            loadingTopic.textContent = `"${topic}"`;
            showView('loading-view');

            try {
                let prompt;
                if (quizType === 'vocabulary') prompt = getVocabularyPrompt(level, topic, 5);
                else if (quizType === 'reading') prompt = getReadingPrompt(level, topic, 3);
                else prompt = getGrammarPrompt(level, 5);
                
                const result = await model.generateContent(prompt);
                const parsedData = extractAndParseQuizJson(result.response.text());
                if (!parsedData) throw new Error("AI did not return valid JSON data.");
                
                quizData.raw = parsedData;
                currentQuestionIndex = 0; score = 0;
                renderQuiz();
                showView('quiz-view');
            } catch (error) {
                showError(`Kh√¥ng th·ªÉ t·∫°o b√†i ki·ªÉm tra. L·ªói: ${error.message}.`);
            }
        }
        
        function renderQuiz() {
            const isReading = quizData.quizType === 'reading';
            const questions = isReading ? quizData.raw.questions : quizData.raw;
            const total = questions.length;
            scoreEl.textContent = `ƒêi·ªÉm: ${score}`;
            progress.textContent = `C√¢u ${currentQuestionIndex + 1} / ${total}`;
            progressBar.style.width = `${((currentQuestionIndex + 1) / total) * 100}%`;
            if (isReading) { passageContainer.classList.remove('hidden'); passageText.textContent = quizData.raw.passage; } 
            else { passageContainer.classList.add('hidden'); }
            renderQuestion();
        }

        function renderQuestion() {
            feedbackContainer.innerHTML = '';
            feedbackContainer.className = 'mt-6 p-4 rounded-lg min-h-[100px]';
            nextQuestionButton.classList.add('hidden');
            const questions = quizData.quizType === 'reading' ? quizData.raw.questions : quizData.raw;
            const currentQuestion = questions[currentQuestionIndex];
            questionText.textContent = currentQuestion.question;
            optionsContainer.innerHTML = '';
            const shuffledOptions = [...currentQuestion.options].sort(() => Math.random() - 0.5);
            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.className = "w-full text-left p-4 border-2 border-slate-300 rounded-lg hover:bg-slate-100 hover:border-sky-400 transition text-lg flex items-center justify-between";
                
                const optionText = document.createElement('span');
                optionText.textContent = option;
                
                const infoBtn = document.createElement('i');
                infoBtn.className = 'info-icon';
                infoBtn.textContent = 'i';
                infoBtn.title = `D·ªãch nghƒ©a "${option}"`;
                infoBtn.onclick = (e) => {
                    e.stopPropagation(); // NgƒÉn kh√¥ng cho s·ª± ki·ªán click lan ra n√∫t cha
                    showTranslationModal(getTranslation(option));
                };

                button.appendChild(optionText);
                button.appendChild(infoBtn);
                button.onclick = () => handleAnswer(option);
                optionsContainer.appendChild(button);
            });
        }

        function handleAnswer(selectedOption) {
            const questions = quizData.quizType === 'reading' ? quizData.raw.questions : quizData.raw;
            const currentQuestion = questions[currentQuestionIndex];
            const isCorrect = selectedOption === currentQuestion.answer;
            Array.from(optionsContainer.children).forEach(button => {
                button.disabled = true; button.classList.add('opacity-70');
                if (button.querySelector('span').textContent === currentQuestion.answer) button.className = "w-full text-left p-4 border-2 border-green-500 bg-green-100 rounded-lg text-lg flex items-center justify-between font-semibold";
                else if (button.querySelector('span').textContent === selectedOption) button.className = "w-full text-left p-4 border-2 border-red-500 bg-red-100 rounded-lg text-lg flex items-center justify-between";
            });
            if (isCorrect) {
                score++;
                feedbackContainer.className = 'mt-6 p-4 rounded-lg bg-green-100 text-green-800';
                feedbackContainer.innerHTML = `<b class="font-bold">Ch√≠nh x√°c!</b><p>${currentQuestion.explanation}</p>`;
            } else {
                feedbackContainer.className = 'mt-6 p-4 rounded-lg bg-red-100 text-red-800';
                feedbackContainer.innerHTML = `<b class="font-bold">Ch∆∞a ƒë√∫ng.</b> ƒê√°p √°n ƒë√∫ng l√† <b>"${currentQuestion.answer}"</b>. <p>${currentQuestion.explanation}</p>`;
            }
            scoreEl.textContent = `ƒêi·ªÉm: ${score}`;
            nextQuestionButton.classList.remove('hidden');
        }

        function moveToNextQuestion() {
            currentQuestionIndex++;
            const questions = quizData.quizType === 'reading' ? quizData.raw.questions : quizData.raw;
            const total = questions.length;
            if (currentQuestionIndex < total) {
                progress.textContent = `C√¢u ${currentQuestionIndex + 1} / ${total}`;
                progressBar.style.width = `${((currentQuestionIndex + 1) / total) * 100}%`;
                renderQuestion();
            } else {
                showResult();
            }
        }

        async function showResult() {
            const questions = quizData.quizType === 'reading' ? quizData.raw.questions : quizData.raw;
            const total = questions.length;
            if (auth.currentUser) {
                await updateUserStreak(auth.currentUser.uid);
                try {
                    await addDoc(collection(db, "quizResults"), {
                        userId: auth.currentUser.uid, topic: quizData.topic, level: quizData.level,
                        type: quizData.quizType, score: score, totalQuestions: total,
                        createdAt: serverTimestamp()
                    });
                } catch (e) { console.error("L·ªói khi l∆∞u k·∫øt qu·∫£: ", e); }
            }
            finalScore.textContent = `${score} / ${total}`;
            const percentage = (score / total) * 100;
            if (percentage === 100) resultMessage.textContent = "Tuy·ªát v·ªùi! B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£!";
            else if (percentage >= 70) resultMessage.textContent = "L√†m t·ªët l·∫Øm! Ki·∫øn th·ª©c c·ªßa b·∫°n r·∫•t ·ªïn.";
            else if (percentage >= 40) resultMessage.textContent = "Kh√° l·∫Øm! Ti·∫øp t·ª•c luy·ªán t·∫≠p nh√©.";
            else resultMessage.textContent = "ƒê·ª´ng n·∫£n l√≤ng! M·ªói l·∫ßn luy·ªán t·∫≠p l√† m·ªôt b∆∞·ªõc ti·∫øn.";
            showView('result-view');
        }

        async function showHistory() {
            if (!auth.currentUser) { showError("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem l·ªãch s·ª≠."); return; }
            showView('history-view');
            historyList.innerHTML = '<div class="spinner mx-auto"></div>';
            try {
                const q = query(collection(db, "quizResults"), where("userId", "==", auth.currentUser.uid));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { historyList.innerHTML = '<p class="text-center text-slate-500">B·∫°n ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i.</p>'; return; }
                historyList.innerHTML = '';
                const results = querySnapshot.docs.map(doc => doc.data()).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                results.forEach(data => {
                    const date = data.createdAt ? data.createdAt.toDate().toLocaleString('vi-VN') : 'Kh√¥ng r√µ';
                    const typeText = data.type === 'reading' ? 'ƒê·ªçc hi·ªÉu' : (data.type === 'grammar' ? 'Ng·ªØ ph√°p' : 'T·ª´ v·ª±ng');
                    const topicText = data.type !== 'grammar' ? `<p class="font-bold text-lg text-slate-800 capitalize">${data.topic} <span class="text-sm font-normal text-indigo-600">(${typeText})</span></p>` : `<p class="font-bold text-lg text-slate-800 capitalize">${typeText}</p>`;
                    historyList.innerHTML += `<div class="bg-slate-50 p-4 rounded-lg border border-slate-200"><div class="flex justify-between items-center">${topicText}<p class="font-bold text-xl ${data.score / data.totalQuestions >= 0.7 ? 'text-green-600' : 'text-orange-500'}">${data.score}/${data.totalQuestions}</p></div><div class="flex justify-between items-center text-sm text-slate-500 mt-1"><span>Tr√¨nh ƒë·ªô: ${data.level.toUpperCase()}</span><span>${date}</span></div></div>`;
                });
            } catch (error) {
                console.error("L·ªói khi t·∫£i l·ªãch s·ª≠: ", error);
                historyList.innerHTML = '<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠.</p>';
            }
        }
        
        function handleQuizTypeChange() {
            const selectedType = quizTypeSelect.value;
            if (selectedType === 'grammar') {
                topicContainer.style.maxHeight = '0'; topicContainer.style.opacity = '0';
                topicContainer.style.overflow = 'hidden'; topicContainer.style.marginTop = '0';
            } else {
                topicContainer.style.maxHeight = '100px'; topicContainer.style.opacity = '1';
                topicContainer.style.overflow = 'visible'; topicContainer.style.marginTop = '1.5rem';
            }
        }

        loginButton.addEventListener('click', () => handleAuthAction('login'));
        registerButton.addEventListener('click', () => handleAuthAction('register'));
        logoutButton.addEventListener('click', handleLogout);
        startQuizButton.addEventListener('click', startQuiz);
        playAgainButton.addEventListener('click', () => showView('setup-view'));
        backToSetupButton.addEventListener('click', () => showView('setup-view'));
        showHistoryButton.addEventListener('click', showHistory);
        backToSetupFromHistory.addEventListener('click', () => showView('setup-view'));
        viewHistoryFromResultButton.addEventListener('click', showHistory);
        nextQuestionButton.addEventListener('click', moveToNextQuestion);
        quizTypeSelect.addEventListener('change', handleQuizTypeChange);
        // N√ÇNG C·∫§P: G√°n s·ª± ki·ªán cho c√°c n√∫t d·ªãch thu·∫≠t
        translateQuestionBtn.addEventListener('click', () => showTranslationModal(getTranslation(questionText.textContent)));
        closeTranslationModal.addEventListener('click', () => translationModal.classList.add('hidden'));
        translationModal.addEventListener('click', (e) => { if (e.target === translationModal) { translationModal.classList.add('hidden'); } });
    </script>
</body>
</html>
