<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI English Quiz - Luy·ªán T·∫≠p To√†n Di·ªán</title>
    <!-- T√≠ch h·ª£p Tailwind CSS ƒë·ªÉ l√†m giao di·ªán -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }
        .view { display: none; animation: fadeIn 0.5s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #0ea5e9; animation: spin 1s ease-in-out infinite; }
        .btn-spinner { width: 20px; height: 20px; border-width: 3px; border-left-color: white; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #passageText, #transcriptContainer, #notebookList, #historyList, #reviewList, #libraryList { max-height: 400px; overflow-y: auto; }
        .topic-container, .vocab-mode-container { transition: all 0.3s ease-in-out; overflow: hidden; }
        #translationModal.hidden, #confirmModal.hidden, #vocabModal.hidden { display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 1rem; max-width: 90%; width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; }
        .translate-icon { cursor: pointer; color: #3b82f6; margin-left: 8px; font-size: 1.25rem; display: inline-block; vertical-align: middle; }
        .info-icon { cursor: pointer; background-color: #dbeafe; color: #3b82f6; border-radius: 50%; width: 22px; height: 22px; font-style: normal; font-weight: bold; display: flex; align-items: center; justify-content: center; margin-left: auto; }
        .highlight-word { background-color: #facc15; color: #1f2937; padding: 2px 0; border-radius: 3px; }
        .save-word-btn { cursor: pointer; color: #64748b; margin-left: 1rem; font-size: 1.5rem; }
        .save-word-btn:hover { color: #0ea5e9; }
        .save-word-btn.saved { color: #22c55e; cursor: not-allowed; }
        .matching-item { cursor: pointer; transition: background-color 0.2s, border-color 0.2s; }
        .matching-item.selected { background-color: #bfdbfe; border-color: #3b82f6; }
        .matching-item.correct { background-color: #dcfce7; border-color: #22c55e; cursor: not-allowed; color: #166534; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .matching-item.incorrect { animation: shake 0.3s; background-color: #fee2e2; border-color: #ef4444; }
        
        /* Flashcard Styles */
        .flashcard-container { perspective: 1000px; }
        .flashcard { width: 100%; min-height: 250px; position: relative; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; border-radius: 1rem; border: 2px solid; }
        .flashcard-front { background-color: #e0f2fe; border-color: #7dd3fc; color: #075985; }
        .flashcard-back { background-color: #f0fdf4; border-color: #86efac; color: #15803d; transform: rotateY(180deg); }
        .speak-btn { background: none; border: none; cursor: pointer; margin-left: 12px; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="appContainer" class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-500">

        <!-- M√†n h√¨nh 0: ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω -->
        <div id="auth-view" class="view active">
            <h1 class="text-3xl font-bold text-center text-sky-600 mb-2">Ch√†o m·ª´ng b·∫°n!</h1>
            <p class="text-center text-slate-500 mb-8">ƒêƒÉng nh·∫≠p ho·∫∑c ƒêƒÉng k√Ω ƒë·ªÉ l∆∞u ti·∫øn tr√¨nh h·ªçc</p>
            <div class="space-y-4">
                <div><label for="emailInput" class="block text-sm font-medium mb-1 text-slate-700">Email</label><input type="email" id="emailInput" placeholder="ten@email.com" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition"></div>
                <div><label for="passwordInput" class="block text-sm font-medium mb-1 text-slate-700">M·∫≠t kh·∫©u</label><input type="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition"></div>
            </div>
            <p id="authError" class="text-red-500 text-sm text-center mt-4 h-5"></p>
            <div class="mt-6 space-y-3">
                 <button id="loginButton" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-3 disabled:bg-sky-300"><span class="btn-text">ƒêƒÉng nh·∫≠p</span><div class="spinner btn-spinner hidden"></div></button>
                 <button id="registerButton" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-3 disabled:bg-slate-400"><span class="btn-text">ƒêƒÉng k√Ω</span><div class="spinner btn-spinner hidden"></div></button>
            </div>
        </div>

        <!-- M√†n h√¨nh 1: Thi·∫øt l·∫≠p b√†i ki·ªÉm tra -->
        <div id="setup-view" class="view">
            <div class="flex justify-between items-start mb-8">
                 <div><h1 class="text-3xl font-bold text-sky-600">AI English Quiz</h1><p id="welcomeMessage" class="text-slate-500">Ch√†o m·ª´ng tr·ªü l·∫°i!</p></div>
                 <div class="flex flex-col items-end space-y-2">
                    <div id="streakDisplay" class="flex items-center justify-center bg-orange-100 text-orange-600 font-bold text-sm px-3 py-1 rounded-full">
                        <span class="mr-1">üî•</span>
                        <span id="streakCount">0</span>
                    </div>
                    <div class="flex space-x-2">
                        <button id="showNotebookButton" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">S·ªï tay</button>
                        <button id="showHistoryButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">L·ªãch s·ª≠</button>
                        <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">ƒêƒÉng xu·∫•t</button>
                    </div>
                 </div>
            </div>

            <!-- N√¢ng c·∫•p: Th√™m n√∫t Th∆∞ vi·ªán -->
            <button id="showLibraryButton" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition-transform transform hover:scale-105 flex items-center justify-center gap-3 mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                Th∆∞ vi·ªán b√†i t·∫≠p
            </button>
            
            <div class="space-y-6">
                <div>
                    <label for="quizTypeSelect" class="block text-lg font-semibold mb-2 text-slate-700">Ch·ªçn k·ªπ nƒÉng luy·ªán t·∫≠p:</label>
                    <select id="quizTypeSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white">
                        <option value="vocabulary" selected>T·ª´ v·ª±ng (Vocabulary)</option>
                        <option value="reading">ƒê·ªçc hi·ªÉu (Reading)</option>
                        <option value="grammar">Ng·ªØ ph√°p (Grammar)</option>
                        <option value="listening">Nghe hi·ªÉu (Listening)</option>
                    </select>
                </div>
                <div id="vocabModeContainer" class="vocab-mode-container">
                    <label for="vocabModeSelect" class="block text-lg font-semibold mb-2 text-slate-700">Ch·ªçn ch·∫ø ƒë·ªô luy·ªán t·∫≠p:</label>
                    <select id="vocabModeSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white">
                        <option value="random" selected>Luy·ªán t·∫≠p Ng·∫´u nhi√™n</option>
                        <option value="multiple_choice">Ch·ªâ luy·ªán Tr·∫Øc nghi·ªám</option>
                        <option value="fill_in_the_blank">Ch·ªâ luy·ªán ƒêi·ªÅn v√†o ch·ªó tr·ªëng</option>
                        <option value="word_formation">Ch·ªâ luy·ªán D·∫°ng c·ªßa t·ª´</option>
                        <option value="word_scramble">Ch·ªâ luy·ªán S·∫Øp x·∫øp ch·ªØ c√°i</option>
                        <option value="matching">Ch·ªâ luy·ªán N·ªëi t·ª´</option>
                        <option value="flashcard">Ch·ªâ luy·ªán Flashcards</option>
                    </select>
                </div>
                <div id="topicContainer" class="topic-container">
                    <label for="topicSelect" class="block text-lg font-semibold mb-2 text-slate-700">Ch·ªçn ch·ªß ƒë·ªÅ b·∫°n y√™u th√≠ch:</label>
                    <select id="topicSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white">
                        <option value="Travel">Du l·ªãch (Travel)</option>
                        <option value="Technology" selected>C√¥ng ngh·ªá (Technology)</option>
                        <option value="Food & Cooking">·∫®m th·ª±c & N·∫•u ƒÉn (Food & Cooking)</option>
                        <option value="Health & Fitness">S·ª©c kh·ªèe & Th·ªÉ h√¨nh (Health & Fitness)</option>
                        <option value="Work & Business">C√¥ng vi·ªác & Kinh doanh (Work & Business)</option>
                        <option value="Movies & Entertainment">Phim ·∫£nh & Gi·∫£i tr√≠ (Movies & Entertainment)</option>
                        <option value="Music">√Çm nh·∫°c (Music)</option>
                        <option value="Sports">Th·ªÉ thao (Sports)</option>
                        <option value="Education">Gi√°o d·ª•c (Education)</option>
                        <option value="Nature & Environment">Thi√™n nhi√™n & M√¥i tr∆∞·ªùng (Nature & Environment)</option>
                        <option value="History">L·ªãch s·ª≠ (History)</option>
                        <option value="Science">Khoa h·ªçc (Science)</option>
                        <option value="Fashion & Shopping">Th·ªùi trang & Mua s·∫Øm (Fashion & Shopping)</option>
                        <option value="Daily Life">Cu·ªôc s·ªëng h√†ng ng√†y (Daily Life)</option>
                        <option value="Relationships">C√°c m·ªëi quan h·ªá (Relationships)</option>
                    </select>
                </div>
                <div><label for="levelSelect" class="block text-lg font-semibold mb-2 text-slate-700">Ch·ªçn tr√¨nh ƒë·ªô c·ªßa b·∫°n:</label><select id="levelSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white"><option value="A2">A2 (Beginner)</option><option value="B1" selected>B1 (Intermediate)</option><option value="B2">B2 (Upper-Intermediate)</option><option value="C1">C1 (Advanced)</option></select></div>
                <div>
                    <label for="questionCountSelect" class="block text-lg font-semibold mb-2 text-slate-700">Ch·ªçn s·ªë l∆∞·ª£ng c√¢u h·ªèi:</label>
                    <select id="questionCountSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white">
                        <option value="5" selected>5 c√¢u (Nhanh)</option>
                        <option value="10">10 c√¢u (Ti√™u chu·∫©n)</option>
                        <option value="15">15 c√¢u (Chuy√™n s√¢u)</option>
                    </select>
                </div>
            </div>
            <button id="startQuizButton" class="mt-10 w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition-transform transform hover:scale-105 flex items-center justify-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path></svg>B·∫Øt ƒë·∫ßu l√†m b√†i</button>
        </div>
        
        <!-- M√†n h√¨nh Th∆∞ vi·ªán b√†i t·∫≠p -->
        <div id="library-view" class="view">
            <div class="flex justify-between items-center mb-4"><h2 class="text-3xl font-bold text-amber-600">Th∆∞ vi·ªán b√†i t·∫≠p</h2><button id="backToSetupFromLibrary" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Quay l·∫°i</button></div>
            <div id="libraryFilters" class="mb-4 flex flex-col md:flex-row gap-4">
                <!-- Filters will be added here if needed -->
            </div>
            <div id="libraryList" class="space-y-3"></div>
        </div>

        <!-- M√†n h√¨nh 1.5: L·ªãch s·ª≠ l√†m b√†i -->
        <div id="history-view" class="view">
            <div class="flex justify-between items-center mb-4"><h2 class="text-3xl font-bold text-indigo-600">L·ªãch s·ª≠ & Ph√¢n t√≠ch</h2><button id="backToSetupFromHistory" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Quay l·∫°i</button></div>
            <div id="historyDashboard" class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-center"></div>
            <div id="recommendationsContainer" class="mb-4"></div>
            <div id="historyFilters" class="mb-4 flex flex-col md:flex-row gap-4">
                <select id="filterSkill" class="w-full md:w-1/2 p-2 border border-slate-300 rounded-lg bg-white"><option value="all">T·∫•t c·∫£ K·ªπ nƒÉng</option><option value="vocabulary">T·ª´ v·ª±ng</option><option value="reading">ƒê·ªçc hi·ªÉu</option><option value="grammar">Ng·ªØ ph√°p</option><option value="listening">Nghe hi·ªÉu</option></select>
                <select id="filterLevel" class="w-full md:w-1/2 p-2 border border-slate-300 rounded-lg bg-white"><option value="all">T·∫•t c·∫£ Tr√¨nh ƒë·ªô</option><option value="A2">A2</option><option value="B1">B1</option><option value="B2">B2</option><option value="C1">C1</option></select>
            </div>
            <div id="historyList" class="space-y-3 max-h-64 overflow-y-auto pr-2"></div>
        </div>

        <!-- M√†n h√¨nh S·ªï tay T·ª´ v·ª±ng -->
        <div id="notebook-view" class="view">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-teal-600">S·ªï tay T·ª´ v·ª±ng</h2>
                <button id="backToSetupFromNotebook" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Quay l·∫°i</button>
            </div>
            <div id="notebookList" class="space-y-3">
                <!-- Danh s√°ch t·ª´ v·ª±ng s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
            </div>
        </div>

        <!-- M√†n h√¨nh 2: ƒêang t·∫£i c√¢u h·ªèi -->
        <div id="loading-view" class="view text-center py-16">
            <div class="spinner mx-auto mb-6"></div><h2 class="text-2xl font-semibold text-slate-700">ƒêang t·∫°o b√†i ki·ªÉm tra...</h2><p class="text-slate-500">AI ƒëang chu·∫©n b·ªã c√°c c√¢u h·ªèi v·ªÅ ch·ªß ƒë·ªÅ <b id="loadingTopic"></b> cho b·∫°n. Vui l√≤ng ch·ªù!</p>
        </div>

        <!-- M√†n h√¨nh 3: L√†m b√†i ki·ªÉm tra -->
        <div id="quiz-view" class="view">
            <div id="quizHeader" class="text-center mb-6 border-b pb-4">
                <h2 id="quizTitle" class="text-2xl font-bold text-sky-700"></h2>
                <p id="quizSubtitle" class="text-slate-500 mt-1"></p>
            </div>
            <div class="flex justify-between items-center mb-4"><div id="progress" class="text-lg font-semibold text-slate-600">C√¢u 1 / 5</div><div id="score" class="text-lg font-bold text-sky-600">ƒêi·ªÉm: 0</div></div>
            <div class="w-full bg-slate-200 rounded-full h-2.5 mb-8"><div id="progressBar" class="bg-sky-500 h-2.5 rounded-full" style="width: 20%"></div></div>
            <div id="audioPlayerContainer" class="hidden mb-2 p-4 bg-slate-800 text-white rounded-lg flex items-center justify-center space-x-4">
                <button id="playAudioBtn" class="p-3 bg-sky-500 rounded-full hover:bg-sky-600 disabled:bg-slate-500 disabled:cursor-not-allowed">
                    <svg id="playIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                    <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                </button>
                <div id="audioStatus" class="text-sm">Nh·∫•n ƒë·ªÉ nghe</div>
            </div>
            <div id="transcriptControls" class="hidden mb-4 text-center">
                <button id="showTranscriptBtn" class="text-sm text-sky-600 hover:underline">Hi·ªán l·ªùi tho·∫°i</button>
            </div>
            <div id="transcriptContainer" class="hidden mb-6 p-3 bg-slate-100 rounded-lg text-slate-700 text-lg leading-relaxed"></div>
            <div id="passageContainer" class="mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200 hidden"><p id="passageText"></p></div>
            <div id="questionContainer" class="mb-6"><p class="text-xl md:text-2xl font-semibold leading-relaxed mb-6"><span id="questionText"></span><span id="translateQuestionBtn" class="translate-icon" title="D·ªãch c√¢u h·ªèi n√†y">üåê</span></p><div id="optionsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
            <div id="feedbackContainer" class="mt-6 p-4 rounded-lg min-h-[100px]"></div>
            <button id="nextQuestionButton" class="hidden mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition">Ti·∫øp t·ª•c</button>
        </div>

        <!-- M√†n h√¨nh 4: K·∫øt qu·∫£ -->
        <div id="result-view" class="view text-center">
            <h2 class="text-3xl font-bold text-slate-800 mb-2">Ho√†n th√†nh!</h2><p class="text-slate-500 text-lg mb-6">ƒê√¢y l√† k·∫øt qu·∫£ c·ªßa b·∫°n:</p>
            <div id="resultScoreContainer" class="bg-sky-100 border-2 border-sky-300 rounded-xl p-8 mb-8"><p class="text-2xl font-semibold mb-2">T·ªïng ƒëi·ªÉm</p><p id="finalScore" class="text-6xl font-bold text-sky-600">4 / 5</p></div>
            <p id="resultMessage" class="text-lg mb-8"></p>
            <div class="flex space-x-4">
                <button id="playAgainButton" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition">L√†m l·∫°i</button>
                <button id="reviewAnswersButton" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition">Xem l·∫°i b√†i l√†m</button>
            </div>
            <button id="viewHistoryFromResultButton" class="mt-4 w-full text-indigo-600 hover:text-indigo-800 font-semibold py-2 px-4 rounded-lg text-md transition">Xem l·ªãch s·ª≠ & ph√¢n t√≠ch</button>
        </div>
        
        <!-- M√†n h√¨nh Xem l·∫°i b√†i l√†m -->
        <div id="review-view" class="view">
             <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-purple-600">Xem l·∫°i b√†i l√†m</h2>
                <button id="backToPreviousViewButton" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Quay l·∫°i</button>
            </div>
            <div id="reviewList" class="space-y-4">
                <!-- N·ªôi dung xem l·∫°i s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
            </div>
        </div>

        <!-- Th√¥ng b√°o l·ªói chung -->
        <div id="error-view" class="view text-center text-red-600 bg-red-100 p-6 rounded-lg">
             <h2 class="text-2xl font-bold mb-4">ƒê√£ x·∫£y ra l·ªói</h2><p id="errorMessage" class="mb-6"></p><button id="backToSetupButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg">Quay l·∫°i</button>
        </div>
    </div>
    
    <!-- Modal hi·ªÉn th·ªã b·∫£n d·ªãch -->
    <div id="translationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-slate-800 mb-4">B·∫£n d·ªãch</h3>
            <div id="translationResult" class="bg-slate-100 p-4 rounded-lg min-h-[80px]">
                <div class="spinner mx-auto"></div>
            </div>
            <button id="closeTranslationModal" class="mt-6 w-full bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg">ƒê√≥ng</button>
        </div>
    </div>

    <!-- Modal x√°c nh·∫≠n -->
    <div id="confirmModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 id="confirmTitle" class="text-xl font-bold text-slate-800 mb-2">X√°c nh·∫≠n</h3>
            <p id="confirmMessage" class="text-slate-600 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th·ª±c hi·ªán h√†nh ƒë·ªông n√†y?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmCancelBtn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-5 rounded-lg">H·ªßy</button>
                <button id="confirmOkBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-5 rounded-lg">X√≥a</button>
            </div>
        </div>
    </div>

    <!-- Modal T·ª´ v·ª±ng li√™n quan -->
    <div id="vocabModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-800">T·ª´ v·ª±ng li√™n quan</h3>
                <button id="closeVocabModal" class="text-2xl font-bold hover:text-red-500">&times;</button>
            </div>
            <div id="vocabList" class="space-y-3 max-h-80 overflow-y-auto">
                <!-- Danh s√°ch t·ª´ v·ª±ng s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, serverTimestamp, doc, getDoc, setDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDgEH2E7W-ltp0IJwYSOjjSitB7xQhI11E",
            authDomain: "engai-374f7.firebaseapp.com",
            projectId: "engai-374f7",
            storageBucket: "engai-374f7.firebasestorage.app",
            messagingSenderId: "793685525357",
            appId: "1:793685525357:web:bf74f624247165fd53d064"
        };

        let app, auth, model, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
        } catch(e) { showError(`L·ªói kh·ªüi t·∫°o: ${e.message}.`); }

        // DOM Elements
        const welcomeMessage = document.getElementById('welcomeMessage'), emailInput = document.getElementById('emailInput'), passwordInput = document.getElementById('passwordInput'), loginButton = document.getElementById('loginButton'), registerButton = document.getElementById('registerButton'), logoutButton = document.getElementById('logoutButton'), authError = document.getElementById('authError'), quizTypeSelect = document.getElementById('quizTypeSelect'), vocabModeContainer = document.getElementById('vocabModeContainer'), vocabModeSelect = document.getElementById('vocabModeSelect'), topicContainer = document.getElementById('topicContainer'), topicSelect = document.getElementById('topicSelect'), levelSelect = document.getElementById('levelSelect'), questionCountSelect = document.getElementById('questionCountSelect'), startQuizButton = document.getElementById('startQuizButton'), showHistoryButton = document.getElementById('showHistoryButton'), showNotebookButton = document.getElementById('showNotebookButton'), showLibraryButton = document.getElementById('showLibraryButton'), libraryList = document.getElementById('libraryList'), backToSetupFromLibrary = document.getElementById('backToSetupFromLibrary'), notebookList = document.getElementById('notebookList'), backToSetupFromNotebook = document.getElementById('backToSetupFromNotebook'), historyDashboard = document.getElementById('historyDashboard'), recommendationsContainer = document.getElementById('recommendationsContainer'), historyFilters = document.getElementById('historyFilters'), filterSkill = document.getElementById('filterSkill'), filterLevel = document.getElementById('filterLevel'), historyList = document.getElementById('historyList'), backToSetupFromHistory = document.getElementById('backToSetupFromHistory'), loadingTopic = document.getElementById('loadingTopic'), quizTitle = document.getElementById('quizTitle'), quizSubtitle = document.getElementById('quizSubtitle'), progress = document.getElementById('progress'), scoreEl = document.getElementById('score'), progressBar = document.getElementById('progressBar'), audioPlayerContainer = document.getElementById('audioPlayerContainer'), playAudioBtn = document.getElementById('playAudioBtn'), playIcon = document.getElementById('playIcon'), pauseIcon = document.getElementById('pauseIcon'), audioStatus = document.getElementById('audioStatus'), transcriptControls = document.getElementById('transcriptControls'), showTranscriptBtn = document.getElementById('showTranscriptBtn'), transcriptContainer = document.getElementById('transcriptContainer'), passageContainer = document.getElementById('passageContainer'), passageText = document.getElementById('passageText'), questionText = document.getElementById('questionText'), translateQuestionBtn = document.getElementById('translateQuestionBtn'), optionsContainer = document.getElementById('optionsContainer'), feedbackContainer = document.getElementById('feedbackContainer'), nextQuestionButton = document.getElementById('nextQuestionButton'), playAgainButton = document.getElementById('playAgainButton'), reviewAnswersButton = document.getElementById('reviewAnswersButton'), reviewList = document.getElementById('reviewList'), backToPreviousViewButton = document.getElementById('backToPreviousViewButton'), viewHistoryFromResultButton = document.getElementById('viewHistoryFromResultButton'), finalScore = document.getElementById('finalScore'), resultMessage = document.getElementById('resultMessage'), resultScoreContainer = document.getElementById('resultScoreContainer'), errorMessage = document.getElementById('errorMessage'), backToSetupButton = document.getElementById('backToSetupButton'), streakCount = document.getElementById('streakCount'), translationModal = document.getElementById('translationModal'), translationResult = document.getElementById('translationResult'), closeTranslationModal = document.getElementById('closeTranslationModal'), confirmModal = document.getElementById('confirmModal'), confirmTitle = document.getElementById('confirmTitle'), confirmMessage = document.getElementById('confirmMessage'), confirmCancelBtn = document.getElementById('confirmCancelBtn'), confirmOkBtn = document.getElementById('confirmOkBtn'), vocabModal = document.getElementById('vocabModal'), vocabList = document.getElementById('vocabList'), closeVocabModal = document.getElementById('closeVocabModal');

        // App State
        let quizData = {};
        let currentQuestionIndex = 0;
        let score = 0;
        let userHistoryCache = []; 
        let sessionResults = [];
        let reviewCameFrom = 'result-view'; 
        let matchingState = {
            selectedWordEl: null,
            correctPairs: 0
        };
        
        // Audio State
        const synth = window.speechSynthesis;
        let audioState = 'idle'; 
        let lastSpokenCharIndex = 0;
        let isPausedByUser = false;

        // --- Core Functions ---
        function showView(viewId) { 
            if (synth.speaking) { synth.cancel(); }
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); 
            document.getElementById(viewId).classList.add('active'); 
        }

        function showError(msg) { 
            errorMessage.textContent = msg; 
            showView('error-view'); 
        }

        // --- Confirmation Modal ---
        function showConfirmModal(message, onConfirm) {
            confirmMessage.textContent = message;
            confirmModal.classList.remove('hidden');

            const handleConfirm = () => {
                onConfirm();
                hideConfirmModal();
            };

            const hideConfirmModal = () => {
                confirmModal.classList.add('hidden');
                confirmOkBtn.removeEventListener('click', handleConfirm);
                confirmCancelBtn.removeEventListener('click', hideConfirmModal);
            };

            confirmOkBtn.addEventListener('click', handleConfirm);
            confirmCancelBtn.addEventListener('click', hideConfirmModal);
        }

        // --- Auth Functions ---
        async function updateUserStreak(userId) {
            const userRef = doc(db, "users", userId);
            const today = new Date().toISOString().slice(0, 10);
            try {
                const userDoc = await getDoc(userRef);
                let currentStreak = 0; let lastActivityDate = '';
                if (userDoc.exists()) { const userData = userDoc.data(); currentStreak = userData.currentStreak || 0; lastActivityDate = userData.lastActivityDate || ''; }
                if (lastActivityDate === today) { streakCount.textContent = currentStreak; return; }
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().slice(0, 10);
                if (lastActivityDate === yesterdayStr) { currentStreak++; } else { currentStreak = 1; }
                await setDoc(userRef, { lastActivityDate: today, currentStreak: currentStreak }, { merge: true });
                streakCount.textContent = currentStreak;
            } catch (error) { console.error("Error updating streak:", error); }
        }

        onAuthStateChanged(auth, user => {
            if (user) { 
                welcomeMessage.textContent = `Ch√†o m·ª´ng, ${user.email}!`; 
                updateUserStreak(user.uid); 
                showView('setup-view'); 
            } else { 
                showView('auth-view'); 
                userHistoryCache = []; 
            }
        });

        const handleAuthAction = async (action) => {
            const email = emailInput.value;
            const password = passwordInput.value; 
            authError.textContent = '';
            if (!email || !password) { 
                authError.textContent = 'Vui l√≤ng nh·∫≠p ƒë·ªß email v√† m·∫≠t kh·∫©u.'; 
                return; 
            }
            const button = action === 'login' ? loginButton : registerButton;
            const otherButton = action === 'login' ? registerButton : loginButton;
            const buttonText = button.querySelector('.btn-text');
            const spinner = button.querySelector('.spinner');
            
            buttonText.textContent = action === 'login' ? 'ƒêang ƒëƒÉng nh·∫≠p...' : 'ƒêang ƒëƒÉng k√Ω...';
            spinner.classList.remove('hidden'); 
            button.disabled = true; 
            otherButton.disabled = true;
            
            try {
                if (action === 'login') { 
                    await signInWithEmailAndPassword(auth, email, password); 
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", userCredential.user.uid), { 
                        email: userCredential.user.email, 
                        createdAt: serverTimestamp(), 
                        currentStreak: 0, 
                        lastActivityDate: '' 
                    });
                }
            } catch (error) { 
                authError.textContent = getFriendlyAuthError(error.code); 
            } finally {
                buttonText.textContent = action === 'login' ? 'ƒêƒÉng nh·∫≠p' : 'ƒêƒÉng k√Ω';
                spinner.classList.add('hidden'); 
                button.disabled = false; 
                otherButton.disabled = false;
            }
        };

        const handleLogout = async () => { 
            try { 
                await signOut(auth); 
            } catch (error) { 
                showError("ƒêƒÉng xu·∫•t th·∫•t b·∫°i."); 
            }
        };

        function getFriendlyAuthError(c) { 
            switch (c) { 
                case 'auth/invalid-email': return 'Email kh√¥ng h·ª£p l·ªá.'; 
                case 'auth/user-not-found': 
                case 'auth/wrong-password': return 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.'; 
                case 'auth/email-already-in-use': return 'Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.'; 
                case 'auth/weak-password': return 'M·∫≠t kh·∫©u qu√° y·∫øu.'; 
                default: return 'L·ªói x√°c th·ª±c.'; 
            } 
        }

        // --- AI & Quiz Generation ---
        function extractAndParseQuizJson(rawText) {
            const quizRegex = /```json\s*([\s\S]*?)\s*```/;
            const match = rawText.match(quizRegex);
            let jsonString = (match && match[1]) ? match[1] : rawText;
            jsonString = jsonString.replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F]/g, '');
            try { return JSON.parse(jsonString); } 
            catch (error) { console.error("JSON Parse Error:", error, "String:", jsonString); return null; }
        }

        async function getTranslation(text) {
            try {
                const prompt = `Translate the following English text to Vietnamese. Provide only the Vietnamese translation, without any extra text or quotation marks: "${text}"`;
                const result = await model.generateContent(prompt);
                return result.response.text();
            } catch (error) { console.error("Translation error:", error); return "Kh√¥ng th·ªÉ d·ªãch ƒë∆∞·ª£c."; }
        }

        function showTranslationModal(textPromise) {
            translationModal.classList.remove('hidden');
            translationResult.innerHTML = '<div class="spinner mx-auto"></div>';
            textPromise.then(translatedText => { translationResult.innerHTML = `<p class="text-lg">${translatedText}</p>`; });
        }
        
        // --- PROMPTS ---
        function getFlashcardPrompt(level, topic, count) {
            return `You are an expert English teacher. Generate ${count} flashcards for an English learner at the ${level} CEFR level. The topic is "${topic}". For each card, provide the English "word", its IPA transcription in the "ipa" field, its Vietnamese "meaning", and an "example" sentence in English using the word. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects: \`\`\`json\n[ { "type": "flashcard", "word": "sustainable", "ipa": "/s…ôÀàste…™n…ôbl/", "meaning": "b·ªÅn v·ªØng", "example": "We need to find more sustainable sources of energy." } ]\n\`\`\``;
        }
        function getMatchingPrompt(level, topic, pairCount) {
            return `You are an expert English teacher. Generate a single 'matching' game question for an English learner at the ${level} CEFR level. The topic is "${topic}". The question object must have a "type" of "matching" and a "pairs" array containing ${pairCount} objects. Each object in the "pairs" array must have an English "word" and its Vietnamese "meaning". You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON object inside a single-element array: \`\`\`json\n[ { "type": "matching", "pairs": [ { "word": "computer", "meaning": "m√°y vi t√≠nh" }, { "word": "keyboard", "meaning": "b√†n ph√≠m" }, { "word": "mouse", "meaning": "con chu·ªôt" }, { "word": "screen", "meaning": "m√†n h√¨nh" }, { "word": "software", "meaning": "ph·∫ßn m·ªÅm" } ] } ]\n\`\`\``;
        }
        function getWordScramblePrompt(level, topic, count) { 
            return `You are an expert English teacher. Generate ${count} 'word scramble' questions for an English learner at the ${level} CEFR level. The topic is "${topic}". For each question, provide a "clue" which is a helpful hint or definition IN VIETNAMESE, and the "answer" which is the single English word to be scrambled. The answer must not contain spaces. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects: \`\`\`json\n[ { "type": "word_scramble", "clue": "M·ªôt lo·∫°i tr√°i c√¢y m√†u ƒë·ªè, th∆∞·ªùng d√πng l√†m salad.", "answer": "tomato" } ]\n\`\`\``; 
        }
        function getVocabularyPrompt(level, topic, count) { return `You are an expert English teacher. Generate ${count} multiple-choice vocabulary questions for an English learner at the ${level} CEFR level. The topic is "${topic}". For the "answer" field, you MUST provide the full text of the correct option, exactly as it appears in the "options" array. Provide one correct answer, three plausible distractors, and a brief, helpful explanation IN VIETNAMESE. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects: \`\`\`json\n[ { "question": "...", "options": ["..."], "answer": "...", "explanation": "..." } ]\n\`\`\``; }
        function getFillInTheBlankPrompt(level, topic, count) { return `You are an expert English teacher. Generate ${count} 'fill-in-the-blank' vocabulary questions for an English learner at the ${level} CEFR level. The topic is "${topic}". For each item, provide a sentence with the target word replaced by "___". Also provide the correct word in the "answer" field. The "answer" MUST be a single word. Provide a brief, helpful explanation IN VIETNAMESE. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects: \`\`\`json\n[ { "type": "fill_in_the_blank", "question": "The government plans to ___ a new high-speed railway.", "answer": "construct", "explanation": "Construct c√≥ nghƒ©a l√† 'x√¢y d·ª±ng', ph√π h·ª£p v·ªõi ng·ªØ c·∫£nh c·ªßa c√¢u." } ]\n\`\`\``; }
        function getWordFormationPrompt(level, topic, count) { return `You are an expert English teacher. Generate ${count} 'word-formation' questions for an English learner at the ${level} CEFR level. The topic is "${topic}". For each item, provide a sentence with a blank and a base word in parentheses. The user must type the correct form of the base word. The "answer" MUST be the single, correctly formed word. Provide a brief, helpful explanation IN VIETNAMESE. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects: \`\`\`json\n[ { "type": "word_formation", "question": "Her ___ to the team was a huge benefit. (contribute)", "answer": "contribution", "explanation": "C·∫ßn m·ªôt danh t·ª´ ·ªü ƒë√¢y. 'Contribution' l√† d·∫°ng danh t·ª´ c·ªßa ƒë·ªông t·ª´ 'contribute'." } ]\n\`\`\``; }
        function getMixedVocabularyPrompt(level, topic, count) { return `You are an expert English teacher. Generate a mixed set of ${count} vocabulary questions for an English learner at the ${level} CEFR level. The topic is "${topic}". The set should include a mix of "multiple_choice", "fill_in_the_blank", "word_formation", "word_scramble", and "matching" types. For each question object, you MUST include a "type" field. - For "multiple_choice": include "options" and "answer" (full text). - For "fill_in_the_blank": the question should contain "___", and the "answer" is the single word to fill it. - For "word_formation": the question should contain a base word in parentheses, and the "answer" is the single, correctly formed word. - For "word_scramble": provide a "clue" (Vietnamese hint) and the "answer" word. - For "matching": provide an array of objects, each with a "word" and "meaning". Provide a brief, helpful explanation IN VIETNAMESE for every question except word_scramble and matching. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects.`; }
        function getReadingPrompt(level, topic, count) { return `You are an expert English teacher. Create a reading comprehension quiz. Generate one short reading passage (about 100-150 words) and ${count} multiple-choice questions about it. The passage topic is "${topic}" and it should be suitable for a ${level} CEFR level learner. For each question, provide one correct answer, three plausible distractors, and a brief, helpful explanation IN VIETNAMESE. For the "answer" field in each question, you MUST provide the full text of the correct option, exactly as it appears in the "options" array. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON object: \`\`\`json\n{ "passage": "...", "questions": [ { "question": "...", "options": ["..."], "answer": "...", "explanation": "..." } ] }\n\`\`\``; }
        function getGrammarPrompt(level, count) { return `You are an expert English grammar teacher. Generate ${count} multiple-choice grammar questions for an English learner at the ${level} CEFR level. Each question should test a common grammar point (e.g., tenses, prepositions, articles, modals). For the "answer" field, you MUST provide the full text of the correct option, exactly as it appears in the "options" array. Provide one correct answer, three plausible distractors, and a brief, helpful explanation IN VIETNAMESE that clearly explains the grammar rule. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects: \`\`\`json\n[ { "question": "...", "options": ["..."], "answer": "...", "explanation": "..." } ]\n\`\`\``; }
        function getListeningPrompt(level, topic, count) { return `You are an expert English teacher. Create a listening comprehension quiz. 1. Generate one short, clear monologue or a simple two-person dialogue (about 50-80 words). The topic is "${topic}" and it should be suitable for a ${level} CEFR level learner. 2. Based on the script, generate ${count} multiple-choice questions. 3. For each question, provide one correct answer, three plausible distractors, and a brief, helpful explanation IN VIETNAMESE. 4. For the "answer" field in each question, you MUST provide the full text of the correct option. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON object: \`\`\`json\n{ "script": "...", "questions": [ { "question": "...", "options": ["..."], "answer": "...", "explanation": "..." } ] }\n\`\`\``; }

        // --- Quiz Lifecycle ---
        async function startQuiz(settings = null) {
            sessionResults = []; 
            const quizType = settings ? settings.type : quizTypeSelect.value;
            const vocabMode = vocabModeSelect.value;
            const topic = settings ? settings.topic : (quizType !== 'grammar' && quizType !== 'listening' ? topicSelect.value : 'General');
            const level = settings ? settings.level : levelSelect.value;
            const count = settings ? (settings.count || 5) : questionCountSelect.value;
            
            quizData = { topic, level, quizType, vocabMode, count };
            loadingTopic.textContent = `"${topic}"`;
            showView('loading-view');
            try {
                let prompt;
                if (quizType === 'vocabulary') {
                    switch(vocabMode) {
                        case 'fill_in_the_blank': prompt = getFillInTheBlankPrompt(level, topic, count); break;
                        case 'word_formation': prompt = getWordFormationPrompt(level, topic, count); break;
                        case 'multiple_choice': prompt = getVocabularyPrompt(level, topic, count); break;
                        case 'word_scramble': prompt = getWordScramblePrompt(level, topic, count); break;
                        case 'matching': prompt = getMatchingPrompt(level, topic, count); break; 
                        case 'flashcard': prompt = getFlashcardPrompt(level, topic, count); break;
                        default: prompt = getMixedVocabularyPrompt(level, topic, count);
                    }
                }
                else if (quizType === 'reading') prompt = getReadingPrompt(level, topic, count);
                else if (quizType === 'grammar') prompt = getGrammarPrompt(level, count);
                else prompt = getListeningPrompt(level, topic, count);
                
                const result = await model.generateContent(prompt);
                const parsedData = extractAndParseQuizJson(result.response.text());
                if (!parsedData) throw new Error("AI did not return valid JSON data.");
                
                quizData.raw = parsedData;
                currentQuestionIndex = 0; score = 0;
                
                // Save the generated quiz to the library
                if (!settings?.isRetry) { // Don't re-save a quiz being retried
                    saveQuizToLibrary(quizData);
                }

                renderQuiz();
                showView('quiz-view');
            } catch (error) {
                showError(`Kh√¥ng th·ªÉ t·∫°o b√†i ki·ªÉm tra. L·ªói: ${error.message}.`);
            }
        }
        
        function renderQuiz() {
            const isReading = quizData.quizType === 'reading';
            const isListening = quizData.quizType === 'listening';
            const questions = isReading || isListening ? quizData.raw.questions : (Array.isArray(quizData.raw) ? quizData.raw : []);
            const total = questions.length;
            
            const typeMap = { vocabulary: 'Luy·ªán t·∫≠p T·ª´ v·ª±ng', reading: 'Luy·ªán t·∫≠p ƒê·ªçc hi·ªÉu', grammar: 'Luy·ªán t·∫≠p Ng·ªØ ph√°p', listening: 'Luy·ªán t·∫≠p Nghe hi·ªÉu' };
            const modeMap = { random: 'Ch·∫ø ƒë·ªô Ng·∫´u nhi√™n', multiple_choice: 'Tr·∫Øc nghi·ªám', fill_in_the_blank: 'ƒêi·ªÅn t·ª´', word_formation: 'D·∫°ng c·ªßa t·ª´', word_scramble: 'S·∫Øp x·∫øp ch·ªØ c√°i', matching: 'N·ªëi t·ª´', flashcard: 'Flashcards' };
            quizTitle.textContent = typeMap[quizData.quizType];
            let subtitleParts = [];
            if (quizData.quizType === 'vocabulary') { subtitleParts.push(modeMap[quizData.vocabMode]); }
            if (quizData.quizType !== 'grammar') { subtitleParts.push(`Ch·ªß ƒë·ªÅ: ${quizData.topic}`); }
            subtitleParts.push(`Tr√¨nh ƒë·ªô: ${quizData.level.toUpperCase()}`);
            quizSubtitle.textContent = subtitleParts.join(' - ');

            scoreEl.style.display = quizData.vocabMode === 'flashcard' ? 'none' : 'block';
            progress.textContent = `C√¢u ${currentQuestionIndex + 1} / ${total}`;
            progressBar.style.width = `${((currentQuestionIndex + 1) / total) * 100}%`;
            
            passageContainer.classList.toggle('hidden', !isReading);
            if (isReading) passageText.textContent = quizData.raw.passage;
            audioPlayerContainer.classList.toggle('hidden', !isListening);
            transcriptControls.classList.toggle('hidden', !isListening);
            transcriptContainer.classList.add('hidden'); 
            if (isListening) setupAudioPlayer();
            renderQuestion();
        }

        function renderQuestion() {
            feedbackContainer.innerHTML = '';
            feedbackContainer.className = 'mt-6 p-4 rounded-lg min-h-[100px]';
            nextQuestionButton.classList.add('hidden');
            const questions = quizData.quizType === 'reading' || quizData.quizType === 'listening' ? quizData.raw.questions : (Array.isArray(quizData.raw) ? quizData.raw : []);
            const currentQuestion = questions[currentQuestionIndex];
            
            optionsContainer.innerHTML = '';
            translateQuestionBtn.style.display = 'inline-block';

            const questionType = currentQuestion.type || 'multiple_choice';

            switch (questionType) {
                case 'flashcard':
                    translateQuestionBtn.style.display = 'none';
                    questionText.textContent = 'Nh·∫•n v√†o th·∫ª ƒë·ªÉ l·∫≠t v√† xem nghƒ©a.';
                    optionsContainer.className = 'flex flex-col items-center gap-4';
                    
                    const cardContainer = document.createElement('div');
                    cardContainer.className = 'flashcard-container w-full';
                    const card = document.createElement('div');
                    card.className = 'flashcard';
                    card.onclick = () => card.classList.toggle('flipped');

                    const front = document.createElement('div');
                    front.className = 'flashcard-face flashcard-front';
                    front.innerHTML = `
                        <div>
                            <div class="flex items-center justify-center">
                                <h3 class="text-4xl font-bold">${currentQuestion.word}</h3>
                                <button class="speak-btn" onclick="event.stopPropagation(); playSpeech('${currentQuestion.word}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600 hover:text-sky-800"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                            </div>
                            <p class="text-xl text-slate-500 mt-2">${currentQuestion.ipa || ''}</p>
                        </div>
                    `;

                    const back = document.createElement('div');
                    back.className = 'flashcard-face flashcard-back';
                    back.innerHTML = `
                        <h4 class="text-3xl font-semibold">${currentQuestion.meaning}</h4>
                        <p class="mt-4 text-lg italic">"${currentQuestion.example}"</p>
                    `;
                    
                    card.appendChild(front);
                    card.appendChild(back);
                    cardContainer.appendChild(card);
                    optionsContainer.appendChild(cardContainer);
                    
                    handleAnswer(null, true); 
                    break;

                case 'matching':
                    translateQuestionBtn.style.display = 'none';
                    questionText.textContent = 'N·ªëi t·ª´ ti·∫øng Anh v·ªõi nghƒ©a t∆∞∆°ng ·ª©ng.';
                    optionsContainer.className = 'grid grid-cols-2 gap-4';

                    const wordsCol = document.createElement('div');
                    wordsCol.className = 'space-y-3';
                    const meaningsCol = document.createElement('div');
                    meaningsCol.className = 'space-y-3';

                    const pairs = currentQuestion.pairs;
                    const shuffledMeanings = [...pairs].sort(() => Math.random() - 0.5);
                    
                    matchingState.correctPairs = 0; // Reset counter

                    pairs.forEach(pair => {
                        const wordEl = document.createElement('div');
                        wordEl.className = 'matching-item p-3 border-2 rounded-lg text-center';
                        wordEl.textContent = pair.word;
                        wordEl.dataset.word = pair.word;
                        wordEl.onclick = () => handleMatchingSelection(wordEl, 'word');
                        wordsCol.appendChild(wordEl);
                    });

                    shuffledMeanings.forEach(pair => {
                        const meaningEl = document.createElement('div');
                        meaningEl.className = 'matching-item p-3 border-2 rounded-lg text-center';
                        meaningEl.textContent = pair.meaning;
                        meaningEl.dataset.word = pair.word; // Associate meaning with its word
                        meaningEl.onclick = () => handleMatchingSelection(meaningEl, 'meaning');
                        meaningsCol.appendChild(meaningEl);
                    });
                    
                    optionsContainer.appendChild(wordsCol);
                    optionsContainer.appendChild(meaningsCol);
                    break;

                case 'word_scramble':
                    translateQuestionBtn.style.display = 'none'; 
                    questionText.textContent = currentQuestion.clue;
                    optionsContainer.className = 'flex flex-col items-center gap-4';
                    
                    const scrambleContainer = document.createElement('div');
                    scrambleContainer.className = 'flex justify-center gap-2 my-4 flex-wrap';
                    
                    const scrambleWord = (word) => {
                        if (word.length < 2) return word;
                        let scrambled;
                        do {
                            scrambled = word.split('').sort(() => 0.5 - Math.random()).join('');
                        } while (scrambled === word);
                        return scrambled;
                    };

                    const scrambled = scrambleWord(currentQuestion.answer);
                    scrambled.split('').forEach(char => {
                        const letterBox = document.createElement('div');
                        letterBox.className = 'w-12 h-12 bg-sky-100 border-2 border-sky-300 rounded-lg flex items-center justify-center text-2xl font-bold text-sky-800 uppercase';
                        letterBox.textContent = char;
                        scrambleContainer.appendChild(letterBox);
                    });
                    optionsContainer.appendChild(scrambleContainer);
                    
                    const textInput = document.createElement('input');
                    textInput.type = 'text';
                    textInput.className = 'w-full md:w-3/4 p-3 border border-slate-400 rounded-lg text-lg text-center focus:ring-2 focus:ring-sky-500 tracking-widest';
                    textInput.placeholder = 'Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n';
                    textInput.onkeydown = (e) => { if (e.key === 'Enter') checkBtn.click(); };
                    
                    const checkBtn = document.createElement('button');
                    checkBtn.textContent = 'Ki·ªÉm tra';
                    checkBtn.className = 'w-full md:w-3/4 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg text-lg';
                    checkBtn.onclick = () => {
                        handleAnswer(textInput.value);
                        textInput.disabled = true;
                        checkBtn.disabled = true;
                        checkBtn.classList.add('opacity-70');
                    };
                    
                    optionsContainer.appendChild(textInput);
                    optionsContainer.appendChild(checkBtn);
                    break;

                case 'multiple_choice':
                    questionText.textContent = currentQuestion.question;
                    optionsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                    const shuffledOptions = [...currentQuestion.options].sort(() => Math.random() - 0.5);
                    shuffledOptions.forEach(option => {
                        const button = document.createElement('button');
                        button.className = "w-full text-left p-4 border-2 border-slate-300 rounded-lg hover:bg-slate-100 hover:border-sky-400 transition text-lg flex items-center justify-between";
                        const optionText = document.createElement('span');
                        optionText.textContent = option;
                        const infoBtn = document.createElement('i');
                        infoBtn.className = 'info-icon';
                        infoBtn.textContent = 'i';
                        infoBtn.title = `D·ªãch nghƒ©a "${option}"`;
                        infoBtn.onclick = (e) => { e.stopPropagation(); showTranslationModal(getTranslation(option)); };
                        button.appendChild(optionText);
                        button.appendChild(infoBtn);
                        button.onclick = () => handleAnswer(option);
                        if (quizData.quizType === 'listening') { button.disabled = true; button.classList.add('opacity-50', 'cursor-not-allowed'); }
                        optionsContainer.appendChild(button);
                    });
                    break;

                case 'fill_in_the_blank':
                case 'word_formation':
                    questionText.textContent = currentQuestion.question;
                    optionsContainer.className = 'flex flex-col items-center gap-4';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.className = 'w-full md:w-3/4 p-3 border border-slate-400 rounded-lg text-lg text-center focus:ring-2 focus:ring-sky-500';
                    input.placeholder = 'Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n...';
                    input.onkeydown = (e) => { if (e.key === 'Enter') checkAnswerBtn.click(); };
                    
                    const checkAnswerBtn = document.createElement('button');
                    checkAnswerBtn.textContent = 'Ki·ªÉm tra';
                    checkAnswerBtn.className = 'w-full md:w-3/4 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg text-lg';
                    checkAnswerBtn.onclick = () => {
                        handleAnswer(input.value);
                        input.disabled = true;
                        checkAnswerBtn.disabled = true;
                        checkAnswerBtn.classList.add('opacity-70');
                    };
                    optionsContainer.appendChild(input);
                    optionsContainer.appendChild(checkAnswerBtn);
                    break;
            }
        }

        function handleMatchingSelection(selectedEl, type) {
            if (selectedEl.classList.contains('correct')) return;

            if (type === 'word') {
                if (matchingState.selectedWordEl) {
                    matchingState.selectedWordEl.classList.remove('selected');
                }
                matchingState.selectedWordEl = selectedEl;
                selectedEl.classList.add('selected');
            } 
            else if (type === 'meaning' && matchingState.selectedWordEl) {
                const wordData = matchingState.selectedWordEl.dataset.word;
                const meaningData = selectedEl.dataset.word;

                if (wordData === meaningData) { // Correct match
                    matchingState.selectedWordEl.className = 'matching-item p-3 border-2 rounded-lg text-center correct';
                    selectedEl.className = 'matching-item p-3 border-2 rounded-lg text-center correct';
                    matchingState.selectedWordEl = null;
                    matchingState.correctPairs++;
                    
                    const totalPairs = quizData.raw[currentQuestionIndex].pairs.length;
                    if (matchingState.correctPairs === totalPairs) {
                        handleAnswer(true); // Mark as correct
                    }
                } else { // Incorrect match
                    const wordEl = matchingState.selectedWordEl;
                    wordEl.classList.add('incorrect');
                    selectedEl.classList.add('incorrect');
                    matchingState.selectedWordEl = null;

                    setTimeout(() => {
                        wordEl.classList.remove('incorrect', 'selected');
                        selectedEl.classList.remove('incorrect');
                    }, 400);
                }
            }
        }


        function handleAnswer(selectedOption, isFlashcard = false) {
            if (isFlashcard) {
                nextQuestionButton.classList.remove('hidden');
                return;
            }

            const questions = quizData.quizType === 'reading' || quizData.quizType === 'listening' ? quizData.raw.questions : (Array.isArray(quizData.raw) ? quizData.raw : []);
            const currentQuestion = questions[currentQuestionIndex];
            const questionType = currentQuestion.type || 'multiple_choice';
            
            let isCorrect;

            if (questionType === 'matching') {
                isCorrect = true; 
                score++;
                feedbackContainer.className = 'mt-6 p-4 rounded-lg bg-green-100 text-green-800';
                feedbackContainer.innerHTML = `<b class="font-bold">Ch√≠nh x√°c!</b><p>B·∫°n ƒë√£ n·ªëi ƒë√∫ng t·∫•t c·∫£ c√°c c·∫∑p.</p>`;
            } else if (questionType === 'multiple_choice') {
                isCorrect = selectedOption === currentQuestion.answer;
                Array.from(optionsContainer.children).forEach(button => {
                    button.disabled = true; button.classList.add('opacity-70');
                    if (button.querySelector('span').textContent === currentQuestion.answer) button.className = "w-full text-left p-4 border-2 border-green-500 bg-green-100 rounded-lg text-lg flex items-center justify-between font-semibold";
                    else if (button.querySelector('span').textContent === selectedOption) button.className = "w-full text-left p-4 border-2 border-red-500 bg-red-100 rounded-lg text-lg flex items-center justify-between";
                });
            } else {
                isCorrect = selectedOption.trim().toLowerCase() === currentQuestion.answer.toLowerCase();
            }

            if (questionType !== 'matching') {
                 if (isCorrect) {
                    score++;
                    feedbackContainer.className = 'mt-6 p-4 rounded-lg bg-green-100 text-green-800';
                    let feedbackHTML = `<b class="font-bold">Ch√≠nh x√°c!</b>`;
                    if(currentQuestion.explanation) {
                        feedbackHTML += `<p>${currentQuestion.explanation}</p>`;
                    }
                    feedbackContainer.innerHTML = feedbackHTML;
                } else {
                    feedbackContainer.className = 'mt-6 p-4 rounded-lg bg-red-100 text-red-800';
                    const displayAnswer = `ƒê√°p √°n ƒë√∫ng l√† <b>"${currentQuestion.answer}"</b>.`;
                    let feedbackHTML = `<b class="font-bold">Ch∆∞a ƒë√∫ng.</b> ${displayAnswer}`;
                    if(currentQuestion.explanation) {
                        feedbackHTML += `<p>${currentQuestion.explanation}</p>`;
                    }
                    feedbackContainer.innerHTML = feedbackHTML;
                }
            }

            if (isCorrect) {
                if(quizData.quizType === 'vocabulary') {
                    const wordsToSave = questionType === 'matching' ? currentQuestion.pairs : [{ word: currentQuestion.answer, definition: currentQuestion.explanation || currentQuestion.clue, example: currentQuestion.question }];
                    
                    wordsToSave.forEach(item => {
                        const saveBtn = document.createElement('span');
                        saveBtn.innerHTML = 'üîñ';
                        saveBtn.className = 'save-word-btn';
                        saveBtn.title = `L∆∞u t·ª´ "${item.word || item.answer}" v√†o s·ªï tay`;
                        saveBtn.onclick = (e) => {
                            saveWordToNotebook(item.word || item.answer, item.meaning || item.definition, item.example);
                            e.target.classList.add('saved');
                            e.target.innerHTML = '‚úÖ';
                            e.target.onclick = null;
                        };
                        feedbackContainer.firstChild.appendChild(saveBtn);
                    });
                }
            }

            scoreEl.textContent = `ƒêi·ªÉm: ${score}`;
            nextQuestionButton.classList.remove('hidden');

            sessionResults.push({
                question: currentQuestion,
                userAnswer: selectedOption,
                isCorrect: isCorrect
            });
        }

        function moveToNextQuestion() {
            currentQuestionIndex++;
            const questions = quizData.quizType === 'reading' || quizData.quizType === 'listening' ? quizData.raw.questions : (Array.isArray(quizData.raw) ? quizData.raw : []);
            const total = questions.length;
            if (currentQuestionIndex < total) {
                renderQuiz();
            } else {
                showResult();
            }
        }

        async function showResult() {
            const questions = quizData.quizType === 'reading' || quizData.quizType === 'listening' ? quizData.raw.questions : (Array.isArray(quizData.raw) ? quizData.raw : []);
            const total = questions.length;
            
            resultScoreContainer.style.display = quizData.vocabMode === 'flashcard' ? 'none' : 'block';
            reviewAnswersButton.style.display = quizData.vocabMode === 'flashcard' ? 'none' : 'block';
            
            if (quizData.vocabMode === 'flashcard') {
                resultMessage.textContent = `Tuy·ªát v·ªùi! B·∫°n ƒë√£ √¥n t·∫≠p xong ${total} th·∫ª.`;
            } else {
                if (auth.currentUser) {
                    await updateUserStreak(auth.currentUser.uid);
                    try {
                        const resultsCollectionRef = collection(db, "users", auth.currentUser.uid, "quizResults");
                        const newResult = { 
                            topic: quizData.topic, 
                            level: quizData.level, 
                            type: quizData.quizType, 
                            vocabMode: quizData.vocabMode, 
                            score: score, 
                            totalQuestions: total, 
                            createdAt: serverTimestamp(),
                            results: sessionResults, 
                            context: { 
                                passage: quizData.raw.passage || null,
                                script: quizData.raw.script || null
                            }
                        };
                        await addDoc(resultsCollectionRef, newResult);
                        userHistoryCache = []; 
                    } catch (e) { console.error("L·ªói khi l∆∞u k·∫øt qu·∫£: ", e); }
                }
                finalScore.textContent = `${score} / ${total}`;
                const percentage = (score / total) * 100;
                if (percentage === 100) resultMessage.textContent = "Tuy·ªát v·ªùi! B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£!";
                else if (percentage >= 70) resultMessage.textContent = "L√†m t·ªët l·∫Øm! Ki·∫øn th·ª©c c·ªßa b·∫°n r·∫•t ·ªïn.";
                else if (percentage >= 40) resultMessage.textContent = "Kh√° l·∫Øm! Ti·∫øp t·ª•c luy·ªán t·∫≠p nh√©.";
                else resultMessage.textContent = "ƒê·ª´ng n·∫£n l√≤ng! M·ªói l·∫ßn luy·ªán t·∫≠p l√† m·ªôt b∆∞·ªõc ti·∫øn.";
            }
            showView('result-view');
        }

        // --- Review & History Functions ---
        function showReviewPage(results, context, cameFromView) {
            reviewList.innerHTML = '';
            reviewCameFrom = cameFromView; 
            showView('review-view');

            if (context?.passage) {
                const passageEl = document.createElement('div');
                passageEl.className = 'p-4 mb-6 bg-slate-100 rounded-lg border border-slate-200';
                passageEl.innerHTML = `<h3 class="text-lg font-bold mb-2 text-slate-700">ƒêo·∫°n vƒÉn</h3><p>${context.passage}</p>`;
                reviewList.appendChild(passageEl);
            }
            if (context?.script) {
                const scriptEl = document.createElement('div');
                scriptEl.className = 'p-4 mb-6 bg-slate-100 rounded-lg border border-slate-200';
                scriptEl.innerHTML = `<h3 class="text-lg font-bold mb-2 text-slate-700">L·ªùi tho·∫°i</h3><p class="italic">"${context.script}"</p>`;
                reviewList.appendChild(scriptEl);
            }

            results.forEach((result, index) => {
                const item = document.createElement('div');
                const q = result.question;
                const userAnswer = result.userAnswer;
                const isCorrect = result.isCorrect;

                item.className = `p-4 rounded-lg border-2 mb-4 ${isCorrect ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'}`;
                
                if (q.type === 'matching') {
                     item.innerHTML = `
                        <p class="font-semibold text-slate-800">${index + 1}. N·ªëi t·ª´</p>
                        <div class="mt-2 text-sm text-slate-600">B·∫°n ƒë√£ ho√†n th√†nh c√¢u h·ªèi n√†y.</div>
                        <ul class="mt-3 pt-3 border-t border-slate-300 space-y-1">
                            ${q.pairs.map(p => `<li class="text-sm"><b>${p.word}</b>: ${p.meaning}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    const resultIcon = isCorrect ? '<span class="text-green-600 font-bold">‚úÖ ƒê√∫ng</span>' : '<span class="text-red-600 font-bold">‚ùå Sai</span>';
                    let answerDetail = '';
                    if (!isCorrect) {
                        answerDetail = `<p class="text-sm text-slate-700 mt-2">ƒê√°p √°n ƒë√∫ng: <b class="text-green-700 font-semibold">${q.answer}</b></p>`;
                    }
                    const questionContent = q.question || `G·ª£i √Ω: ${q.clue}`;
                    const explanationHTML = q.explanation ? `<p class="mt-3 pt-3 border-t border-slate-300 text-sm text-slate-600"><b class="font-semibold">Gi·∫£i th√≠ch:</b> ${q.explanation}</p>` : '';

                    item.innerHTML = `
                        <p class="font-semibold text-slate-800">${index + 1}. ${questionContent}</p>
                        <p class="text-sm text-slate-700 mt-2">C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n: <b class="${isCorrect ? 'text-green-700' : 'text-red-700'} font-semibold">${userAnswer || '(Ch∆∞a tr·∫£ l·ªùi)'}</b> ${resultIcon}</p>
                        ${answerDetail}
                        ${explanationHTML}
                    `;
                }
                reviewList.appendChild(item);
            });
        }
        
        async function reviewHistoricQuiz(resultId) {
            if (!auth.currentUser) return;
            historyList.innerHTML = '<div class="spinner mx-auto"></div>'; 
            try {
                const resultDocRef = doc(db, "users", auth.currentUser.uid, "quizResults", resultId);
                const docSnap = await getDoc(resultDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    showReviewPage(data.results, data.context, 'history-view');
                } else {
                    showError("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu b√†i l√†m n√†y.");
                }
            } catch (error) {
                console.error("L·ªói khi t·∫£i b√†i l√†m ƒë·ªÉ xem l·∫°i:", error);
                showError("Kh√¥ng th·ªÉ t·∫£i b√†i l√†m ƒë·ªÉ xem l·∫°i.");
            }
        }

        async function showHistory() {
            if (!auth.currentUser) { showError("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem l·ªãch s·ª≠."); return; }
            showView('history-view');
            historyList.innerHTML = '<div class="spinner mx-auto"></div>';
            historyDashboard.innerHTML = '';
            recommendationsContainer.innerHTML = '';
            try {
                const historyCollectionRef = collection(db, "users", auth.currentUser.uid, "quizResults");
                const q = query(historyCollectionRef);
                const querySnapshot = await getDocs(q);
                userHistoryCache = querySnapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                
                if (userHistoryCache.length === 0) { 
                    historyList.innerHTML = '<p class="text-center text-slate-500">B·∫°n ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i n√†o.</p>'; 
                    historyDashboard.innerHTML = '';
                    recommendationsContainer.innerHTML = '';
                    return; 
                }
                const stats = calculateStats(userHistoryCache);
                displayHistoryStats(stats);
                generateRecommendations(stats);
                renderHistoryList();
            } catch (error) {
                console.error("L·ªói khi t·∫£i l·ªãch s·ª≠: ", error);
                historyList.innerHTML = '<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠.</p>';
            }
        }
        
        function renderHistoryList() {
            const skill = filterSkill.value;
            const level = filterLevel.value;
            const filteredResults = userHistoryCache.filter(res => (skill === 'all' || res.type === skill) && (level === 'all' || res.level === level));
            if (filteredResults.length === 0) { historyList.innerHTML = '<p class="text-center text-slate-500">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.</p>'; return; }
            historyList.innerHTML = '';
            filteredResults.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).forEach(data => {
                const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString('vi-VN') : 'N/A';
                const typeText = data.type === 'reading' ? 'ƒê·ªçc hi·ªÉu' : (data.type === 'grammar' ? 'Ng·ªØ ph√°p' : (data.type === 'listening' ? 'Nghe hi·ªÉu' : 'T·ª´ v·ª±ng'));
                const topicText = data.type !== 'grammar' ? `<p class="font-bold text-base text-slate-800 capitalize">${data.topic} <span class="text-sm font-normal text-indigo-600">(${typeText})</span></p>` : `<p class="font-bold text-base text-slate-800 capitalize">${typeText}</p>`;
                const item = document.createElement('div');
                item.className = 'bg-slate-50 p-3 rounded-lg border border-slate-200';
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            ${topicText}
                            <div class="text-xs text-slate-500 mt-1">
                                <span>Tr√¨nh ƒë·ªô: ${data.level.toUpperCase()}</span> | <span>${date}</span>
                            </div>
                        </div>
                        <p class="font-bold text-xl ${data.score / data.totalQuestions >= 0.7 ? 'text-green-600' : 'text-orange-500'}">${data.score}/${data.totalQuestions}</p>
                    </div>
                    <div class="flex justify-end items-center space-x-2 mt-2 pt-2 border-t border-slate-200">
                        <button class="review-hist-button bg-purple-500 hover:bg-purple-600 text-white text-xs font-bold py-1 px-3 rounded-full" data-result-id="${data.id}">Xem l·∫°i</button>
                        <button class="retry-button bg-sky-500 hover:bg-sky-600 text-white text-xs font-bold py-1 px-3 rounded-full" data-type="${data.type}" data-topic="${data.topic || ''}" data-level="${data.level}">L√†m l·∫°i</button>
                    </div>`;
                historyList.appendChild(item);
            });
            
            document.querySelectorAll('.retry-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const { type, topic, level } = e.target.dataset;
                    startQuiz({ type, topic, level });
                });
            });
            document.querySelectorAll('.review-hist-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    reviewHistoricQuiz(e.target.dataset.resultId);
                });
            });
        }

        function calculateStats(results) {
            let totalCorrect = 0, totalQuestions = 0;
            const skillStats = { vocabulary: {c:0, t:0}, reading: {c:0, t:0}, grammar: {c:0, t:0}, listening: {c:0, t:0} };
            const topicStats = {};
            results.forEach(res => {
                totalCorrect += res.score; totalQuestions += res.totalQuestions;
                if (skillStats[res.type]) { skillStats[res.type].c += res.score; skillStats[res.type].t += res.totalQuestions; }
                if (res.type !== 'grammar') { if (!topicStats[res.topic]) topicStats[res.topic] = {c:0, t:0}; topicStats[res.topic].c += res.score; topicStats[res.topic].t += res.totalQuestions; }
            });
            return { totalCorrect, totalQuestions, skillStats, topicStats };
        }

        function displayHistoryStats(stats) {
            const { totalCorrect, totalQuestions, skillStats, topicStats } = stats;
            const overallRate = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            const findBest = (s) => Object.entries(s).filter(([, v]) => v.t > 0).reduce((b, [k, v]) => (v.c / v.t > b.rate ? { key: k, rate: v.c / v.t } : b), { key: 'N/A', rate: -1 });
            const bestSkill = findBest(skillStats);
            const bestTopic = findBest(topicStats);
            const typeMap = { vocabulary: 'T·ª´ v·ª±ng', reading: 'ƒê·ªçc hi·ªÉu', grammar: 'Ng·ªØ ph√°p', listening: 'Nghe hi·ªÉu' };
            historyDashboard.innerHTML = `
                <div class="bg-blue-100 p-4 rounded-lg"><div class="text-sm text-blue-600 font-semibold">T·ª∑ l·ªá ƒë√∫ng</div><div class="text-3xl font-bold text-blue-800">${overallRate}%</div></div>
                <div class="bg-green-100 p-4 rounded-lg"><div class="text-sm text-green-600 font-semibold">K·ªπ nƒÉng t·ªët nh·∫•t</div><div class="text-2xl font-bold text-green-800 capitalize">${typeMap[bestSkill.key] || 'Ch∆∞a c√≥'}</div></div>
                <div class="bg-purple-100 p-4 rounded-lg"><div class="text-sm text-purple-600 font-semibold">Ch·ªß ƒë·ªÅ t·ªët nh·∫•t</div><div class="text-2xl font-bold text-purple-800 capitalize">${bestTopic.key || 'Ch∆∞a c√≥'}</div></div>`;
        }

        function generateRecommendations(stats) {
            const { skillStats } = stats;
            const recommendations = [];
            const findWorst = (s) => Object.entries(s).filter(([, v]) => v.t > 2).reduce((w, [k, v]) => (v.c / v.t < w.rate ? { key: k, rate: v.c / v.t } : w), { key: 'N/A', rate: 2 });
            const worstSkill = findWorst(skillStats);
            const typeMap = { vocabulary: 'T·ª´ v·ª±ng', reading: 'ƒê·ªçc hi·ªÉu', grammar: 'Ng·ªØ ph√°p', listening: 'Nghe hi·ªÉu' };
            if (worstSkill.key !== 'N/A' && worstSkill.rate < 0.7) {
                recommendations.push({ text: `C√≥ v·∫ª b·∫°n c·∫ßn c·∫£i thi·ªán k·ªπ nƒÉng <b>${typeMap[worstSkill.key]}</b>. Th·ª≠ m·ªôt b√†i ngay?`, settings: { type: worstSkill.key, level: 'B1', topic: 'General' } });
            }
            const findBest = (s) => Object.entries(s).filter(([, v]) => v.t > 2).reduce((b, [k, v]) => (v.c / v.t > b.rate ? { key: k, rate: v.c / v.t } : b), { key: 'N/A', rate: -1 });
            const bestSkill = findBest(skillStats);
            const levelOrder = ['A2', 'B1', 'B2', 'C1'];
            if (bestSkill.key !== 'N/A' && bestSkill.rate > 0.8) {
                const currentLevelIndex = levelOrder.indexOf('B1'); // Assume current level for now
                if (currentLevelIndex < levelOrder.length - 1) {
                    const nextLevel = levelOrder[currentLevelIndex + 1];
                    recommendations.push({ text: `B·∫°n l√†m r·∫•t t·ªët <b>${typeMap[bestSkill.key]}</b>! Th·ª≠ s·ª©c ·ªü tr√¨nh ƒë·ªô <b>${nextLevel}</b> nh√©?`, settings: { type: bestSkill.key, level: nextLevel, topic: 'General' } });
                }
            }
            if (recommendations.length === 0 && userHistoryCache.length > 0) {
                recommendations.push({ text: "B·∫°n ƒëang l√†m r·∫•t t·ªët! H√£y ti·∫øp t·ª•c ph√°t huy nh√©!", settings: null });
            }
            recommendationsContainer.innerHTML = recommendations.length > 0 ? `<h3 class="text-lg font-bold text-slate-700 mb-2">G·ª£i √Ω cho b·∫°n</h3>` : '';
            recommendations.forEach(rec => {
                const recButton = document.createElement('button');
                recButton.innerHTML = rec.text;
                recButton.className = "w-full text-left p-3 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg hover:bg-yellow-200 transition mb-2";
                if (rec.settings) { recButton.onclick = () => startQuiz(rec.settings); } 
                else { recButton.disabled = true; }
                recommendationsContainer.appendChild(recButton);
            });
        }
        
        // --- Notebook Functions ---
        async function saveWordToNotebook(word, definition, example) {
            if (!auth.currentUser) return;
            const notebookRef = collection(db, "users", auth.currentUser.uid, "vocabulary");
            try {
                await addDoc(notebookRef, {
                    word: word || 'Kh√¥ng x√°c ƒë·ªãnh',
                    definition: definition || 'Ch∆∞a c√≥ gi·∫£i th√≠ch.',
                    example: example || 'Ch∆∞a c√≥ c√¢u v√≠ d·ª•.',
                    addedAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error saving word:", error);
            }
        }

        async function showNotebook() {
            if (!auth.currentUser) { showError("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem s·ªï tay."); return; }
            showView('notebook-view');
            notebookList.innerHTML = '<div class="spinner mx-auto"></div>';

            try {
                const notebookRef = collection(db, "users", auth.currentUser.uid, "vocabulary");
                const q = query(notebookRef);
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    notebookList.innerHTML = '<p class="text-center text-slate-500">S·ªï tay c·ªßa b·∫°n c√≤n tr·ªëng. H√£y l∆∞u t·ª´ m·ªõi sau khi l√†m b√†i nh√©!</p>';
                    return;
                }

                notebookList.innerHTML = '';
                querySnapshot.forEach((docSnapshot) => {
                    const wordData = docSnapshot.data();
                    const wordId = docSnapshot.id;
                    const card = document.createElement('div');
                    card.className = 'bg-teal-50 p-4 rounded-lg border border-teal-200';
                    card.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-xl font-bold text-teal-800">${wordData.word}</h4>
                                <p class="text-slate-600">${wordData.definition}</p>
                                <p class="text-sm text-slate-500 italic mt-2">"${wordData.example}"</p>
                            </div>
                            <button class="delete-word-btn text-red-400 hover:text-red-600 text-2xl" data-id="${wordId}" title="X√≥a t·ª´ n√†y">üóëÔ∏è</button>
                        </div>
                    `;
                    notebookList.appendChild(card);
                });

                document.querySelectorAll('.delete-word-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const wordId = e.currentTarget.dataset.id;
                        showConfirmModal('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t·ª´ n√†y kh·ªèi s·ªï tay?', async () => {
                            const wordDocRef = doc(db, "users", auth.currentUser.uid, "vocabulary", wordId);
                            await deleteDoc(wordDocRef);
                            e.currentTarget.closest('.bg-teal-50').remove();
                        });
                    });
                });

            } catch (error) {
                console.error("Error loading notebook:", error);
                notebookList.innerHTML = '<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i s·ªï tay t·ª´ v·ª±ng.</p>';
            }
        }

        // --- Audio Functions ---
        function playSpeech(text, startIndex = 0) {
            if (synth.speaking) { synth.cancel(); }
            isPausedByUser = false;
            const utterance = new SpeechSynthesisUtterance(text.substring(startIndex));
            const voices = synth.getVoices();
            utterance.voice = voices.find(voice => voice.lang.startsWith('en-')) || voices[0];
            utterance.rate = 0.9;
            const words = text.split(/(\s+)/);
            const wordElements = words.map(word => { const span = document.createElement('span'); span.textContent = word; return span; });
            transcriptContainer.innerHTML = '';
            wordElements.forEach(el => transcriptContainer.appendChild(el));
            let charCounter = 0;
            const wordBoundaries = words.map(word => { const start = charCounter; charCounter += word.length; return { word, start, end: charCounter }; });
            utterance.onboundary = (event) => {
                lastSpokenCharIndex = startIndex + event.charIndex;
                wordElements.forEach(el => el.classList.remove('highlight-word'));
                for(let i = 0; i < wordBoundaries.length; i++) {
                    if (lastSpokenCharIndex >= wordBoundaries[i].start && lastSpokenCharIndex < wordBoundaries[i].end) {
                        wordElements[i].classList.add('highlight-word');
                        break;
                    }
                }
            };
            utterance.onstart = () => { audioState = 'playing'; playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden'); audioStatus.textContent = "ƒêang ph√°t..."; };
            utterance.onend = () => {
                if (!isPausedByUser) {
                    lastSpokenCharIndex = 0;
                    audioState = 'idle';
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    audioStatus.textContent = "Nghe l·∫°i";
                    Array.from(optionsContainer.children).forEach(button => { button.disabled = false; button.classList.remove('opacity-50', 'cursor-not-allowed'); });
                    wordElements.forEach(el => el.classList.remove('highlight-word'));
                }
            };
            utterance.onerror = (e) => { audioState = 'idle'; audioStatus.textContent = "L·ªói ph√°t √¢m thanh"; console.error("SpeechSynthesis Error:", e); };
            synth.speak(utterance);
        }

        function setupAudioPlayer() {
            audioState = 'idle';
            lastSpokenCharIndex = 0;
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            audioStatus.textContent = "Nh·∫•n ƒë·ªÉ nghe";
            playAudioBtn.disabled = false;
        }

        // --- Library Functions ---
        async function saveQuizToLibrary(quizDataToSave) {
            if (!auth.currentUser) return;
            const libraryRef = collection(db, "quizLibrary");
            try {
                const docRef = await addDoc(libraryRef, {
                    creatorId: auth.currentUser.uid,
                    topic: quizDataToSave.topic,
                    level: quizDataToSave.level,
                    quizType: quizDataToSave.quizType,
                    vocabMode: quizDataToSave.vocabMode,
                    count: quizDataToSave.count,
                    quizContent: quizDataToSave.raw,
                    createdAt: serverTimestamp()
                });
                // Now, extract and save vocabulary for the new library entry
                extractAndSaveVocabulary(quizDataToSave.raw, docRef.id);
            } catch (error) {
                console.error("Error saving quiz to library:", error);
            }
        }

        async function extractAndSaveVocabulary(quizContent, docId) {
            const prompt = `From the following quiz JSON content, extract a list of 5 to 7 key vocabulary words. For each word, provide the English word, its Vietnamese meaning, and its IPA transcription. Format the output as a JSON array of objects. JSON: ${JSON.stringify(quizContent)}`;
            try {
                const result = await model.generateContent(prompt);
                const parsedVocab = extractAndParseQuizJson(result.response.text());
                if (parsedVocab) {
                    const docRef = doc(db, "quizLibrary", docId);
                    await updateDoc(docRef, {
                        relatedVocabulary: parsedVocab
                    });
                }
            } catch (error) {
                console.error("Error extracting or saving vocabulary:", error);
            }
        }

        async function showLibrary() {
            showView('library-view');
            libraryList.innerHTML = '<div class="spinner mx-auto"></div>';
            const libraryRef = collection(db, "quizLibrary");
            try {
                const querySnapshot = await getDocs(query(libraryRef));
                const quizzes = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLibraryList(quizzes);
            } catch (error) {
                console.error("Error fetching quiz library:", error);
                libraryList.innerHTML = '<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán.</p>';
            }
        }

        function renderLibraryList(quizzes) {
            if (quizzes.length === 0) {
                libraryList.innerHTML = '<p class="text-center text-slate-500">Th∆∞ vi·ªán c·ªßa b·∫°n c√≤n tr·ªëng. H√£y t·∫°o m·ªôt b√†i t·∫≠p m·ªõi ƒë·ªÉ th√™m v√†o ƒë√¢y!</p>';
                return;
            }
            libraryList.innerHTML = '';
            quizzes.forEach(quiz => {
                const date = quiz.createdAt ? new Date(quiz.createdAt.seconds * 1000).toLocaleDateString('vi-VN') : 'N/A';
                const typeText = quiz.quizType === 'reading' ? 'ƒê·ªçc hi·ªÉu' : (quiz.quizType === 'grammar' ? 'Ng·ªØ ph√°p' : (quiz.quizType === 'listening' ? 'Nghe hi·ªÉu' : 'T·ª´ v·ª±ng'));
                const item = document.createElement('div');
                item.className = 'bg-slate-50 p-3 rounded-lg border border-slate-200';
                item.innerHTML = `
                    <p class="font-bold text-base text-slate-800 capitalize">${quiz.topic} <span class="text-sm font-normal text-amber-600">(${typeText})</span></p>
                    <div class="text-xs text-slate-500 mt-1">
                        <span>Tr√¨nh ƒë·ªô: ${quiz.level.toUpperCase()}</span> | <span>${quiz.count} c√¢u</span> | <span>Ng√†y t·∫°o: ${date}</span>
                    </div>
                    <div class="flex justify-end items-center space-x-2 mt-2 pt-2 border-t border-slate-200">
                        <button class="view-vocab-btn bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded-full" data-quiz-id="${quiz.id}">Xem t·ª´ v·ª±ng</button>
                        <button class="retry-library-btn bg-sky-500 hover:bg-sky-600 text-white text-xs font-bold py-1 px-3 rounded-full" data-quiz-id="${quiz.id}">L√†m l·∫°i</button>
                    </div>`;
                libraryList.appendChild(item);
            });

            document.querySelectorAll('.retry-library-btn').forEach(button => {
                button.addEventListener('click', (e) => retrySavedQuiz(e.target.dataset.quizId));
            });
            document.querySelectorAll('.view-vocab-btn').forEach(button => {
                button.addEventListener('click', (e) => showRelatedVocabulary(e.target.dataset.quizId));
            });
        }

        async function retrySavedQuiz(quizId) {
            const docRef = doc(db, "quizLibrary", quizId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const savedQuiz = docSnap.data();
                    startQuiz({
                        type: savedQuiz.quizType,
                        topic: savedQuiz.topic,
                        level: savedQuiz.level,
                        count: savedQuiz.count,
                        isRetry: true // Flag to prevent re-saving
                    });
                    // Directly set quizData.raw from the saved content
                    quizData.raw = savedQuiz.quizContent;
                    currentQuestionIndex = 0;
                    score = 0;
                    renderQuiz();
                    showView('quiz-view');
                }
            } catch (error) {
                showError("Kh√¥ng th·ªÉ t·∫£i l·∫°i b√†i t·∫≠p n√†y.");
            }
        }

        async function showRelatedVocabulary(quizId) {
            const docRef = doc(db, "quizLibrary", quizId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().relatedVocabulary) {
                    const vocabData = docSnap.data().relatedVocabulary;
                    vocabList.innerHTML = '';
                    vocabData.forEach(v => {
                        const item = document.createElement('div');
                        item.className = 'p-2 border-b';
                        item.innerHTML = `
                            <div class="flex items-center">
                                <b class="text-lg text-slate-800">${v.word}</b>
                                <span class="ml-2 text-slate-500">${v.ipa || ''}</span>
                                <button class="speak-btn ml-auto" onclick="playSpeech('${v.word}')">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600 hover:text-sky-800"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                </button>
                            </div>
                            <p class="text-slate-600">${v.meaning}</p>
                        `;
                        vocabList.appendChild(item);
                    });
                    vocabModal.classList.remove('hidden');
                } else {
                    showError("Kh√¥ng c√≥ t·ª´ v·ª±ng li√™n quan cho b√†i t·∫≠p n√†y.");
                }
            } catch (error) {
                showError("Kh√¥ng th·ªÉ t·∫£i danh s√°ch t·ª´ v·ª±ng.");
            }
        }
        
        // --- Event Listeners & Setup ---
        function handleQuizTypeChange() {
            const selectedType = quizTypeSelect.value;
            const isVocab = selectedType === 'vocabulary';
            const isTopicBased = isVocab || selectedType === 'reading' || selectedType === 'listening';
            
            vocabModeContainer.style.maxHeight = isVocab ? '150px' : '0'; 
            vocabModeContainer.style.opacity = isVocab ? '1' : '0';
            vocabModeContainer.style.marginTop = isVocab ? '1.5rem' : '0';
            
            if (!isTopicBased) {
                topicContainer.style.maxHeight = '0'; topicContainer.style.opacity = '0';
                topicContainer.style.overflow = 'hidden'; topicContainer.style.marginTop = '0';
            } else {
                topicContainer.style.maxHeight = '100px'; topicContainer.style.opacity = '1';
                topicContainer.style.overflow = 'visible';
                topicContainer.style.marginTop = '1.5rem';
            }
        }

        loginButton.addEventListener('click', () => handleAuthAction('login'));
        registerButton.addEventListener('click', () => handleAuthAction('register'));
        logoutButton.addEventListener('click', handleLogout);
        startQuizButton.addEventListener('click', () => startQuiz());
        playAgainButton.addEventListener('click', () => showView('setup-view'));
        backToSetupButton.addEventListener('click', () => showView('setup-view'));
        showHistoryButton.addEventListener('click', showHistory);
        showNotebookButton.addEventListener('click', showNotebook);
        showLibraryButton.addEventListener('click', showLibrary);
        backToSetupFromLibrary.addEventListener('click', () => showView('setup-view'));
        backToSetupFromHistory.addEventListener('click', () => showView('setup-view'));
        backToSetupFromNotebook.addEventListener('click', () => showView('setup-view'));
        viewHistoryFromResultButton.addEventListener('click', showHistory);
        nextQuestionButton.addEventListener('click', moveToNextQuestion);
        quizTypeSelect.addEventListener('change', handleQuizTypeChange);
        translateQuestionBtn.addEventListener('click', () => showTranslationModal(getTranslation(questionText.textContent)));
        closeTranslationModal.addEventListener('click', () => translationModal.classList.add('hidden'));
        translationModal.addEventListener('click', (e) => { if (e.target === translationModal) { translationModal.classList.add('hidden'); } });
        closeVocabModal.addEventListener('click', () => vocabModal.classList.add('hidden'));
        vocabModal.addEventListener('click', (e) => { if (e.target === vocabModal) { vocabModal.classList.add('hidden'); } });
        filterSkill.addEventListener('change', renderHistoryList);
        filterLevel.addEventListener('change', renderHistoryList);
        
        playAudioBtn.addEventListener('click', () => {
            if (audioState === 'playing') {
                isPausedByUser = true;
                synth.cancel();
                audioState = 'paused';
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                audioStatus.textContent = "ƒê√£ t·∫°m d·ª´ng";
            } else { 
                playSpeech(quizData.raw.script, lastSpokenCharIndex);
            }
        });
        
        showTranscriptBtn.addEventListener('click', () => {
            const isHidden = transcriptContainer.classList.toggle('hidden');
            showTranscriptBtn.textContent = isHidden ? 'Hi·ªán l·ªùi tho·∫°i' : '·∫®n l·ªùi tho·∫°i';
        });

        reviewAnswersButton.addEventListener('click', () => {
            const context = {
                passage: quizData.raw.passage || null,
                script: quizData.raw.script || null
            };
            showReviewPage(sessionResults, context, 'result-view');
        });
        
        backToPreviousViewButton.addEventListener('click', () => showView(reviewCameFrom));

        // Initial setup
        handleQuizTypeChange();

    </script>
</body>
</html>
