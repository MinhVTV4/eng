<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI English Quiz - Luy·ªán T·∫≠p To√†n Di·ªán</title>
    <!-- T√≠ch h·ª£p Tailwind CSS ƒë·ªÉ l√†m giao di·ªán -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; }
        .view { display: none; animation: fadeIn 0.5s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #0ea5e9; animation: spin 1s ease-in-out infinite; }
        .btn-spinner { width: 20px; height: 20px; border-width: 3px; border-left-color: white; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #passageText, #transcriptContainer { max-height: 200px; overflow-y: auto; }
        .topic-container, .vocab-mode-container { transition: all 0.3s ease-in-out; overflow: hidden; }
        #translationModal.hidden { display: none; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 1rem; max-width: 90%; width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; }
        .translate-icon { cursor: pointer; color: #3b82f6; margin-left: 8px; font-size: 1.25rem; display: inline-block; vertical-align: middle; }
        .info-icon { cursor: pointer; background-color: #dbeafe; color: #3b82f6; border-radius: 50%; width: 22px; height: 22px; font-style: normal; font-weight: bold; display: flex; align-items: center; justify-content: center; margin-left: auto; }
        .highlight-word {
            background-color: #facc15; /* yellow-400 */
            color: #1f2937; /* gray-800 */
            padding: 2px 0;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 flex items-center justify-center min-h-screen p-4">

    <div id="appContainer" class="w-full max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-500">

        <!-- M√†n h√¨nh 0: ƒêƒÉng nh·∫≠p / ƒêƒÉng k√Ω -->
        <div id="auth-view" class="view active">
            <h1 class="text-3xl font-bold text-center text-sky-600 mb-2">Ch√†o m·ª´ng b·∫°n!</h1>
            <p class="text-center text-slate-500 mb-8">ƒêƒÉng nh·∫≠p ho·∫∑c ƒêƒÉng k√Ω ƒë·ªÉ l∆∞u ti·∫øn tr√¨nh h·ªçc</p>
            <div class="space-y-4">
                <div><label for="emailInput" class="block text-sm font-medium mb-1 text-slate-700">Email</label><input type="email" id="emailInput" placeholder="ten@email.com" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition"></div>
                <div><label for="passwordInput" class="block text-sm font-medium mb-1 text-slate-700">M·∫≠t kh·∫©u</label><input type="password" id="passwordInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition"></div>
            </div>
            <p id="authError" class="text-red-500 text-sm text-center mt-4 h-5"></p>
            <div class="mt-6 space-y-3">
                 <button id="loginButton" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-3 disabled:bg-sky-300"><span class="btn-text">ƒêƒÉng nh·∫≠p</span><div class="spinner btn-spinner hidden"></div></button>
                 <button id="registerButton" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition-transform transform hover:scale-105 flex items-center justify-center gap-3 disabled:bg-slate-400"><span class="btn-text">ƒêƒÉng k√Ω</span><div class="spinner btn-spinner hidden"></div></button>
            </div>
        </div>

        <!-- M√†n h√¨nh 1: Thi·∫øt l·∫≠p b√†i ki·ªÉm tra -->
        <div id="setup-view" class="view">
            <div class="flex justify-between items-start mb-8">
                 <div><h1 class="text-3xl font-bold text-sky-600">AI English Quiz</h1><p id="welcomeMessage" class="text-slate-500">Ch√†o m·ª´ng tr·ªü l·∫°i!</p></div>
                 <div class="flex flex-col items-end space-y-2">
                    <div id="streakDisplay" class="flex items-center justify-center bg-orange-100 text-orange-600 font-bold text-sm px-3 py-1 rounded-full">
                        <span class="mr-1">üî•</span>
                        <span id="streakCount">0</span>
                    </div>
                    <div class="flex space-x-2">
                        <button id="showHistoryButton" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">L·ªãch s·ª≠</button>
                        <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">ƒêƒÉng xu·∫•t</button>
                    </div>
                 </div>
            </div>
            <div class="space-y-6">
                <div>
                    <label for="quizTypeSelect" class="block text-lg font-semibold mb-2 text-slate-700">Ch·ªçn k·ªπ nƒÉng luy·ªán t·∫≠p:</label>
                    <select id="quizTypeSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white">
                        <option value="vocabulary" selected>T·ª´ v·ª±ng (Vocabulary)</option>
                        <option value="reading">ƒê·ªçc hi·ªÉu (Reading)</option>
                        <option value="grammar">Ng·ªØ ph√°p (Grammar)</option>
                        <option value="listening">Nghe hi·ªÉu (Listening)</option>
                    </select>
                </div>
                <div id="vocabModeContainer" class="vocab-mode-container">
                    <label for="vocabModeSelect" class="block text-lg font-semibold mb-2 text-slate-700">Ch·ªçn ch·∫ø ƒë·ªô luy·ªán t·∫≠p:</label>
                    <select id="vocabModeSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white">
                        <option value="random" selected>Luy·ªán t·∫≠p Ng·∫´u nhi√™n</option>
                        <option value="multiple_choice">Ch·ªâ luy·ªán Tr·∫Øc nghi·ªám</option>
                        <option value="fill_in_the_blank">Ch·ªâ luy·ªán ƒêi·ªÅn v√†o ch·ªó tr·ªëng</option>
                        <option value="word_formation">Ch·ªâ luy·ªán D·∫°ng c·ªßa t·ª´</option>
                    </select>
                </div>
                <div id="topicContainer" class="topic-container">
                    <label for="topicSelect" class="block text-lg font-semibold mb-2 text-slate-700">Ch·ªçn ch·ªß ƒë·ªÅ b·∫°n y√™u th√≠ch:</label>
                    <select id="topicSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white">
                        <option value="Travel">Du l·ªãch (Travel)</option>
                        <option value="Technology" selected>C√¥ng ngh·ªá (Technology)</option>
                        <option value="Food & Cooking">·∫®m th·ª±c & N·∫•u ƒÉn (Food & Cooking)</option>
                        <option value="Health & Fitness">S·ª©c kh·ªèe & Th·ªÉ h√¨nh (Health & Fitness)</option>
                        <option value="Work & Business">C√¥ng vi·ªác & Kinh doanh (Work & Business)</option>
                        <option value="Movies & Entertainment">Phim ·∫£nh & Gi·∫£i tr√≠ (Movies & Entertainment)</option>
                        <option value="Music">√Çm nh·∫°c (Music)</option>
                        <option value="Sports">Th·ªÉ thao (Sports)</option>
                        <option value="Education">Gi√°o d·ª•c (Education)</option>
                        <option value="Nature & Environment">Thi√™n nhi√™n & M√¥i tr∆∞·ªùng (Nature & Environment)</option>
                        <option value="History">L·ªãch s·ª≠ (History)</option>
                        <option value="Science">Khoa h·ªçc (Science)</option>
                        <option value="Fashion & Shopping">Th·ªùi trang & Mua s·∫Øm (Fashion & Shopping)</option>
                        <option value="Daily Life">Cu·ªôc s·ªëng h√†ng ng√†y (Daily Life)</option>
                        <option value="Relationships">C√°c m·ªëi quan h·ªá (Relationships)</option>
                    </select>
                </div>
                <div><label for="levelSelect" class="block text-lg font-semibold mb-2 text-slate-700">Ch·ªçn tr√¨nh ƒë·ªô c·ªßa b·∫°n:</label><select id="levelSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition bg-white"><option value="A2">A2 (Beginner)</option><option value="B1" selected>B1 (Intermediate)</option><option value="B2">B2 (Upper-Intermediate)</option><option value="C1">C1 (Advanced)</option></select></div>
            </div>
            <button id="startQuizButton" class="mt-10 w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition-transform transform hover:scale-105 flex items-center justify-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z"></path></svg>B·∫Øt ƒë·∫ßu l√†m b√†i</button>
        </div>
        
        <!-- M√†n h√¨nh 1.5: L·ªãch s·ª≠ l√†m b√†i -->
        <div id="history-view" class="view">
            <div class="flex justify-between items-center mb-4"><h2 class="text-3xl font-bold text-indigo-600">L·ªãch s·ª≠ & Ph√¢n t√≠ch</h2><button id="backToSetupFromHistory" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Quay l·∫°i</button></div>
            <div id="historyDashboard" class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4 text-center"></div>
            <div id="recommendationsContainer" class="mb-4"></div>
            <div id="historyFilters" class="mb-4 flex flex-col md:flex-row gap-4">
                <select id="filterSkill" class="w-full md:w-1/2 p-2 border border-slate-300 rounded-lg bg-white"><option value="all">T·∫•t c·∫£ K·ªπ nƒÉng</option><option value="vocabulary">T·ª´ v·ª±ng</option><option value="reading">ƒê·ªçc hi·ªÉu</option><option value="grammar">Ng·ªØ ph√°p</option><option value="listening">Nghe hi·ªÉu</option></select>
                <select id="filterLevel" class="w-full md:w-1/2 p-2 border border-slate-300 rounded-lg bg-white"><option value="all">T·∫•t c·∫£ Tr√¨nh ƒë·ªô</option><option value="A2">A2</option><option value="B1">B1</option><option value="B2">B2</option><option value="C1">C1</option></select>
            </div>
            <div id="historyList" class="space-y-3 max-h-64 overflow-y-auto pr-2"></div>
        </div>

        <!-- M√†n h√¨nh 2: ƒêang t·∫£i c√¢u h·ªèi -->
        <div id="loading-view" class="view text-center py-16">
            <div class="spinner mx-auto mb-6"></div><h2 class="text-2xl font-semibold text-slate-700">ƒêang t·∫°o b√†i ki·ªÉm tra...</h2><p class="text-slate-500">AI ƒëang chu·∫©n b·ªã c√°c c√¢u h·ªèi v·ªÅ ch·ªß ƒë·ªÅ <b id="loadingTopic"></b> cho b·∫°n. Vui l√≤ng ch·ªù!</p>
        </div>

        <!-- M√†n h√¨nh 3: L√†m b√†i ki·ªÉm tra -->
        <div id="quiz-view" class="view">
            <div id="quizHeader" class="text-center mb-6 border-b pb-4">
                <h2 id="quizTitle" class="text-2xl font-bold text-sky-700"></h2>
                <p id="quizSubtitle" class="text-slate-500 mt-1"></p>
            </div>
            <div class="flex justify-between items-center mb-4"><div id="progress" class="text-lg font-semibold text-slate-600">C√¢u 1 / 5</div><div id="score" class="text-lg font-bold text-sky-600">ƒêi·ªÉm: 0</div></div>
            <div class="w-full bg-slate-200 rounded-full h-2.5 mb-8"><div id="progressBar" class="bg-sky-500 h-2.5 rounded-full" style="width: 20%"></div></div>
            <div id="audioPlayerContainer" class="hidden mb-2 p-4 bg-slate-800 text-white rounded-lg flex items-center justify-center space-x-4">
                <button id="playAudioBtn" class="p-3 bg-sky-500 rounded-full hover:bg-sky-600 disabled:bg-slate-500 disabled:cursor-not-allowed">
                    <svg id="playIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg>
                    <svg id="pauseIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                </button>
                <div id="audioStatus" class="text-sm">Nh·∫•n ƒë·ªÉ nghe</div>
            </div>
            <div id="transcriptControls" class="hidden mb-4 text-center">
                <button id="showTranscriptBtn" class="text-sm text-sky-600 hover:underline">Hi·ªán l·ªùi tho·∫°i</button>
            </div>
            <div id="transcriptContainer" class="hidden mb-6 p-3 bg-slate-100 rounded-lg text-slate-700 text-lg leading-relaxed"></div>
            <div id="passageContainer" class="mb-6 bg-slate-50 p-4 rounded-lg border border-slate-200 hidden"><p id="passageText"></p></div>
            <div id="questionContainer" class="mb-6"><p class="text-xl md:text-2xl font-semibold leading-relaxed mb-6"><span id="questionText"></span><span id="translateQuestionBtn" class="translate-icon" title="D·ªãch c√¢u h·ªèi n√†y">üåê</span></p><div id="optionsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div>
            <div id="feedbackContainer" class="mt-6 p-4 rounded-lg min-h-[100px]"></div>
            <button id="nextQuestionButton" class="hidden mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition">Ti·∫øp t·ª•c</button>
        </div>

        <!-- M√†n h√¨nh 4: K·∫øt qu·∫£ -->
        <div id="result-view" class="view text-center">
            <h2 class="text-3xl font-bold text-slate-800 mb-2">Ho√†n th√†nh!</h2><p class="text-slate-500 text-lg mb-6">ƒê√¢y l√† k·∫øt qu·∫£ c·ªßa b·∫°n:</p>
            <div class="bg-sky-100 border-2 border-sky-300 rounded-xl p-8 mb-8"><p class="text-2xl font-semibold mb-2">T·ªïng ƒëi·ªÉm</p><p id="finalScore" class="text-6xl font-bold text-sky-600">4 / 5</p></div>
            <p id="resultMessage" class="text-lg mb-8"></p>
            <div class="flex space-x-4"><button id="playAgainButton" class="w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition">L√†m l·∫°i</button><button id="viewHistoryFromResultButton" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-4 rounded-lg text-xl transition">Xem l·ªãch s·ª≠</button></div>
        </div>
        
        <!-- Th√¥ng b√°o l·ªói chung -->
        <div id="error-view" class="view text-center text-red-600 bg-red-100 p-6 rounded-lg">
             <h2 class="text-2xl font-bold mb-4">ƒê√£ x·∫£y ra l·ªói</h2><p id="errorMessage" class="mb-6"></p><button id="backToSetupButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg">Quay l·∫°i</button>
        </div>
    </div>
    
    <!-- Modal hi·ªÉn th·ªã b·∫£n d·ªãch -->
    <div id="translationModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-slate-800 mb-4">B·∫£n d·ªãch</h3>
            <div id="translationResult" class="bg-slate-100 p-4 rounded-lg min-h-[80px]">
                <div class="spinner mx-auto"></div>
            </div>
            <button id="closeTranslationModal" class="mt-6 w-full bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-4 rounded-lg">ƒê√≥ng</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-ai.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDgEH2E7W-ltp0IJwYSOjjSitB7xQhI11E",
            authDomain: "engai-374f7.firebaseapp.com",
            projectId: "engai-374f7",
            storageBucket: "engai-374f7.firebasestorage.app",
            messagingSenderId: "793685525357",
            appId: "1:793685525357:web:bf74f624247165fd53d064"
        };

        let app, auth, model, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { model: "gemini-2.5-flash" });
        } catch(e) { showError(`L·ªói kh·ªüi t·∫°o: ${e.message}.`); }

        const welcomeMessage = document.getElementById('welcomeMessage'), emailInput = document.getElementById('emailInput'), passwordInput = document.getElementById('passwordInput'), loginButton = document.getElementById('loginButton'), registerButton = document.getElementById('registerButton'), logoutButton = document.getElementById('logoutButton'), authError = document.getElementById('authError'), quizTypeSelect = document.getElementById('quizTypeSelect'), vocabModeContainer = document.getElementById('vocabModeContainer'), vocabModeSelect = document.getElementById('vocabModeSelect'), topicContainer = document.getElementById('topicContainer'), topicSelect = document.getElementById('topicSelect'), levelSelect = document.getElementById('levelSelect'), startQuizButton = document.getElementById('startQuizButton'), showHistoryButton = document.getElementById('showHistoryButton'), historyDashboard = document.getElementById('historyDashboard'), recommendationsContainer = document.getElementById('recommendationsContainer'), historyFilters = document.getElementById('historyFilters'), filterSkill = document.getElementById('filterSkill'), filterLevel = document.getElementById('filterLevel'), historyList = document.getElementById('historyList'), backToSetupFromHistory = document.getElementById('backToSetupFromHistory'), loadingTopic = document.getElementById('loadingTopic'), quizTitle = document.getElementById('quizTitle'), quizSubtitle = document.getElementById('quizSubtitle'), progress = document.getElementById('progress'), scoreEl = document.getElementById('score'), progressBar = document.getElementById('progressBar'), audioPlayerContainer = document.getElementById('audioPlayerContainer'), playAudioBtn = document.getElementById('playAudioBtn'), playIcon = document.getElementById('playIcon'), pauseIcon = document.getElementById('pauseIcon'), audioStatus = document.getElementById('audioStatus'), transcriptControls = document.getElementById('transcriptControls'), showTranscriptBtn = document.getElementById('showTranscriptBtn'), transcriptContainer = document.getElementById('transcriptContainer'), passageContainer = document.getElementById('passageContainer'), passageText = document.getElementById('passageText'), questionText = document.getElementById('questionText'), translateQuestionBtn = document.getElementById('translateQuestionBtn'), optionsContainer = document.getElementById('optionsContainer'), feedbackContainer = document.getElementById('feedbackContainer'), nextQuestionButton = document.getElementById('nextQuestionButton'), playAgainButton = document.getElementById('playAgainButton'), viewHistoryFromResultButton = document.getElementById('viewHistoryFromResultButton'), finalScore = document.getElementById('finalScore'), resultMessage = document.getElementById('resultMessage'), errorMessage = document.getElementById('errorMessage'), backToSetupButton = document.getElementById('backToSetupButton'), streakCount = document.getElementById('streakCount'), translationModal = document.getElementById('translationModal'), translationResult = document.getElementById('translationResult'), closeTranslationModal = document.getElementById('closeTranslationModal');

        let quizData = {};
        let currentQuestionIndex = 0;
        let score = 0;
        let allUserResults = []; 
        
        const synth = window.speechSynthesis;
        let audioState = 'idle'; 
        let lastSpokenCharIndex = 0;
        let isPausedByUser = false;

        async function updateUserStreak(userId) {
            const userRef = doc(db, "users", userId);
            const today = new Date().toISOString().slice(0, 10);
            try {
                const userDoc = await getDoc(userRef);
                let currentStreak = 0; let lastActivityDate = '';
                if (userDoc.exists()) { const userData = userDoc.data(); currentStreak = userData.currentStreak || 0; lastActivityDate = userData.lastActivityDate || ''; }
                if (lastActivityDate === today) { streakCount.textContent = currentStreak; return; }
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().slice(0, 10);
                if (lastActivityDate === yesterdayStr) { currentStreak++; } else { currentStreak = 1; }
                await setDoc(userRef, { lastActivityDate: today, currentStreak: currentStreak }, { merge: true });
                streakCount.textContent = currentStreak;
            } catch (error) { console.error("Error updating streak:", error); }
        }

        onAuthStateChanged(auth, user => {
            if (user) { 
                welcomeMessage.textContent = `Ch√†o m·ª´ng, ${user.email}!`; 
                updateUserStreak(user.uid); 
                showView('setup-view'); 
            } 
            else { 
                showView('auth-view'); 
                allUserResults = []; 
            }
        });

        const handleAuthAction = async (action) => {
            const email = emailInput.value;
            const password = passwordInput.value; 
            authError.textContent = '';
            if (!email || !password) { 
                authError.textContent = 'Vui l√≤ng nh·∫≠p ƒë·ªß email v√† m·∫≠t kh·∫©u.'; 
                return; 
            }
            const button = action === 'login' ? loginButton : registerButton;
            const otherButton = action === 'login' ? registerButton : loginButton;
            const buttonText = button.querySelector('.btn-text');
            const spinner = button.querySelector('.spinner');
            
            buttonText.textContent = action === 'login' ? 'ƒêang ƒëƒÉng nh·∫≠p...' : 'ƒêang ƒëƒÉng k√Ω...';
            spinner.classList.remove('hidden'); 
            button.disabled = true; 
            otherButton.disabled = true;
            
            try {
                if (action === 'login') { 
                    await signInWithEmailAndPassword(auth, email, password); 
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await setDoc(doc(db, "users", userCredential.user.uid), { 
                        email: userCredential.user.email, 
                        createdAt: serverTimestamp(), 
                        currentStreak: 0, 
                        lastActivityDate: '' 
                    });
                }
            } catch (error) { 
                authError.textContent = getFriendlyAuthError(error.code); 
            } finally {
                buttonText.textContent = action === 'login' ? 'ƒêƒÉng nh·∫≠p' : 'ƒêƒÉng k√Ω';
                spinner.classList.add('hidden'); 
                button.disabled = false; 
                otherButton.disabled = false;
            }
        };

        const handleLogout = async () => { 
            try { 
                if (synth.speaking) { synth.cancel(); }
                await signOut(auth); 
            } catch (error) { 
                showError("ƒêƒÉng xu·∫•t th·∫•t b·∫°i."); 
            }
        };

        function getFriendlyAuthError(c) { 
            switch (c) { 
                case 'auth/invalid-email': return 'Email kh√¥ng h·ª£p l·ªá.'; 
                case 'auth/user-not-found': 
                case 'auth/wrong-password': return 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.'; 
                case 'auth/email-already-in-use': return 'Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng.'; 
                case 'auth/weak-password': return 'M·∫≠t kh·∫©u qu√° y·∫øu.'; 
                default: return 'L·ªói x√°c th·ª±c.'; 
            } 
        }

        function showView(viewId) { if (synth.speaking) { synth.cancel(); } document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(viewId).classList.add('active'); }
        function showError(msg) { errorMessage.textContent = msg; showView('error-view'); }
        function extractAndParseQuizJson(rawText) {
            const quizRegex = /```json\s*([\s\S]*?)\s*```/;
            const match = rawText.match(quizRegex);
            let jsonString = (match && match[1]) ? match[1] : rawText;
            jsonString = jsonString.replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F]/g, '');
            try { return JSON.parse(jsonString); } 
            catch (error) { console.error("JSON Parse Error:", error, "String:", jsonString); return null; }
        }
        async function getTranslation(text) {
            try {
                const prompt = `Translate the following English text to Vietnamese. Provide only the Vietnamese translation, without any extra text or quotation marks: "${text}"`;
                const result = await model.generateContent(prompt);
                return result.response.text();
            } catch (error) { console.error("Translation error:", error); return "Kh√¥ng th·ªÉ d·ªãch ƒë∆∞·ª£c."; }
        }
        function showTranslationModal(textPromise) {
            translationModal.classList.remove('hidden');
            translationResult.innerHTML = '<div class="spinner mx-auto"></div>';
            textPromise.then(translatedText => { translationResult.innerHTML = `<p class="text-lg">${translatedText}</p>`; });
        }

        function getVocabularyPrompt(level, topic, count) { return `You are an expert English teacher. Generate ${count} multiple-choice vocabulary questions for an English learner at the ${level} CEFR level. The topic is "${topic}". For the "answer" field, you MUST provide the full text of the correct option, exactly as it appears in the "options" array. Provide one correct answer, three plausible distractors, and a brief, helpful explanation IN VIETNAMESE. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects: \`\`\`json\n[ { "question": "...", "options": ["..."], "answer": "...", "explanation": "..." } ]\n\`\`\``; }
        function getFillInTheBlankPrompt(level, topic, count) { return `You are an expert English teacher. Generate ${count} 'fill-in-the-blank' vocabulary questions for an English learner at the ${level} CEFR level. The topic is "${topic}". For each item, provide a sentence with the target word replaced by "___". Also provide the correct word in the "answer" field. The "answer" MUST be a single word. Provide a brief, helpful explanation IN VIETNAMESE. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects: \`\`\`json\n[ { "type": "fill_in_the_blank", "question": "The government plans to ___ a new high-speed railway.", "answer": "construct", "explanation": "Construct c√≥ nghƒ©a l√† 'x√¢y d·ª±ng', ph√π h·ª£p v·ªõi ng·ªØ c·∫£nh c·ªßa c√¢u." } ]\n\`\`\``; }
        function getWordFormationPrompt(level, topic, count) { return `You are an expert English teacher. Generate ${count} 'word-formation' questions for an English learner at the ${level} CEFR level. The topic is "${topic}". For each item, provide a sentence with a blank and a base word in parentheses. The user must type the correct form of the base word. The "answer" MUST be the single, correctly formed word. Provide a brief, helpful explanation IN VIETNAMESE. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects: \`\`\`json\n[ { "type": "word_formation", "question": "Her ___ to the team was a huge benefit. (contribute)", "answer": "contribution", "explanation": "C·∫ßn m·ªôt danh t·ª´ ·ªü ƒë√¢y. 'Contribution' l√† d·∫°ng danh t·ª´ c·ªßa ƒë·ªông t·ª´ 'contribute'." } ]\n\`\`\``; }
        function getMixedVocabularyPrompt(level, topic, count) { return `You are an expert English teacher. Generate a mixed set of ${count} vocabulary questions for an English learner at the ${level} CEFR level. The topic is "${topic}". The set should include a mix of "multiple_choice", "fill_in_the_blank", and "word_formation" types. For each question object, you MUST include a "type" field. - For "multiple_choice": include "options" and "answer" (full text). - For "fill_in_the_blank": the question should contain "___", and the "answer" is the single word to fill it. - For "word_formation": the question should contain a base word in parentheses, and the "answer" is the single, correctly formed word. Provide a brief, helpful explanation IN VIETNAMESE for every question. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects.`; }
        function getReadingPrompt(level, topic, count) { return `You are an expert English teacher. Create a reading comprehension quiz. Generate one short reading passage (about 100-150 words) and ${count} multiple-choice questions about it. The passage topic is "${topic}" and it should be suitable for a ${level} CEFR level learner. For each question, provide one correct answer, three plausible distractors, and a brief, helpful explanation IN VIETNAMESE. For the "answer" field in each question, you MUST provide the full text of the correct option, exactly as it appears in the "options" array. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON object: \`\`\`json\n{ "passage": "...", "questions": [ { "question": "...", "options": ["..."], "answer": "...", "explanation": "..." } ] }\n\`\`\``; }
        function getGrammarPrompt(level, count) { return `You are an expert English grammar teacher. Generate ${count} multiple-choice grammar questions for an English learner at the ${level} CEFR level. Each question should test a common grammar point (e.g., tenses, prepositions, articles, modals). For the "answer" field, you MUST provide the full text of the correct option, exactly as it appears in the "options" array. Provide one correct answer, three plausible distractors, and a brief, helpful explanation IN VIETNAMESE that clearly explains the grammar rule. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON array of objects: \`\`\`json\n[ { "question": "...", "options": ["..."], "answer": "...", "explanation": "..." } ]\n\`\`\``; }
        function getListeningPrompt(level, topic, count) { return `You are an expert English teacher. Create a listening comprehension quiz. 1. Generate one short, clear monologue or a simple two-person dialogue (about 50-80 words). The topic is "${topic}" and it should be suitable for a ${level} CEFR level learner. 2. Based on the script, generate ${count} multiple-choice questions. 3. For each question, provide one correct answer, three plausible distractors, and a brief, helpful explanation IN VIETNAMESE. 4. For the "answer" field in each question, you MUST provide the full text of the correct option. You MUST wrap your entire response in a 'json' markdown code block. The structure MUST be a valid JSON object: \`\`\`json\n{ "script": "...", "questions": [ { "question": "...", "options": ["..."], "answer": "...", "explanation": "..." } ] }\n\`\`\``; }

        async function startQuiz(settings = null) {
            const quizType = settings ? settings.type : quizTypeSelect.value;
            const vocabMode = vocabModeSelect.value;
            const topic = settings ? settings.topic : (quizType !== 'grammar' && quizType !== 'listening' ? topicSelect.value : 'General');
            const level = settings ? settings.level : levelSelect.value;
            
            quizData = { topic, level, quizType, vocabMode };
            loadingTopic.textContent = `"${topic}"`;
            showView('loading-view');
            try {
                let prompt;
                if (quizType === 'vocabulary') {
                    switch(vocabMode) {
                        case 'fill_in_the_blank': prompt = getFillInTheBlankPrompt(level, topic, 5); break;
                        case 'word_formation': prompt = getWordFormationPrompt(level, topic, 5); break;
                        case 'multiple_choice': prompt = getVocabularyPrompt(level, topic, 5); break;
                        default: prompt = getMixedVocabularyPrompt(level, topic, 5);
                    }
                }
                else if (quizType === 'reading') prompt = getReadingPrompt(level, topic, 3);
                else if (quizType === 'grammar') prompt = getGrammarPrompt(level, 5);
                else prompt = getListeningPrompt(level, topic, 3);
                
                const result = await model.generateContent(prompt);
                const parsedData = extractAndParseQuizJson(result.response.text());
                if (!parsedData) throw new Error("AI did not return valid JSON data.");
                
                quizData.raw = parsedData;
                currentQuestionIndex = 0; score = 0;
                renderQuiz();
                showView('quiz-view');
            } catch (error) {
                showError(`Kh√¥ng th·ªÉ t·∫°o b√†i ki·ªÉm tra. L·ªói: ${error.message}.`);
            }
        }
        
        function renderQuiz() {
            const isReading = quizData.quizType === 'reading';
            const isListening = quizData.quizType === 'listening';
            const questions = isReading || isListening ? quizData.raw.questions : quizData.raw;
            const total = questions.length;
            
            const typeMap = { vocabulary: 'Luy·ªán t·∫≠p T·ª´ v·ª±ng', reading: 'Luy·ªán t·∫≠p ƒê·ªçc hi·ªÉu', grammar: 'Luy·ªán t·∫≠p Ng·ªØ ph√°p', listening: 'Luy·ªán t·∫≠p Nghe hi·ªÉu' };
            const modeMap = { random: 'Ch·∫ø ƒë·ªô Ng·∫´u nhi√™n', multiple_choice: 'Tr·∫Øc nghi·ªám', fill_in_the_blank: 'ƒêi·ªÅn t·ª´', word_formation: 'D·∫°ng c·ªßa t·ª´' };
            quizTitle.textContent = typeMap[quizData.quizType];
            let subtitleParts = [];
            if (quizData.quizType === 'vocabulary') { subtitleParts.push(modeMap[quizData.vocabMode]); }
            if (quizData.quizType !== 'grammar') { subtitleParts.push(`Ch·ªß ƒë·ªÅ: ${quizData.topic}`); }
            subtitleParts.push(`Tr√¨nh ƒë·ªô: ${quizData.level.toUpperCase()}`);
            quizSubtitle.textContent = subtitleParts.join(' - ');

            scoreEl.textContent = `ƒêi·ªÉm: ${score}`;
            progress.textContent = `C√¢u ${currentQuestionIndex + 1} / ${total}`;
            progressBar.style.width = `${((currentQuestionIndex + 1) / total) * 100}%`;
            passageContainer.classList.toggle('hidden', !isReading);
            if (isReading) passageText.textContent = quizData.raw.passage;
            audioPlayerContainer.classList.toggle('hidden', !isListening);
            transcriptControls.classList.toggle('hidden', !isListening);
            transcriptContainer.classList.add('hidden'); 
            if (isListening) setupAudioPlayer();
            renderQuestion();
        }

        function playSpeech(text, startIndex = 0) {
            if (synth.speaking) { synth.cancel(); }
            isPausedByUser = false;
            const utterance = new SpeechSynthesisUtterance(text.substring(startIndex));
            const voices = synth.getVoices();
            utterance.voice = voices.find(voice => voice.lang.startsWith('en-')) || voices[0];
            utterance.rate = 0.9;
            const words = text.split(/(\s+)/);
            const wordElements = words.map(word => { const span = document.createElement('span'); span.textContent = word; return span; });
            transcriptContainer.innerHTML = '';
            wordElements.forEach(el => transcriptContainer.appendChild(el));
            let charCounter = 0;
            const wordBoundaries = words.map(word => { const start = charCounter; charCounter += word.length; return { word, start, end: charCounter }; });
            utterance.onboundary = (event) => {
                lastSpokenCharIndex = startIndex + event.charIndex;
                wordElements.forEach(el => el.classList.remove('highlight-word'));
                for(let i = 0; i < wordBoundaries.length; i++) {
                    if (lastSpokenCharIndex >= wordBoundaries[i].start && lastSpokenCharIndex < wordBoundaries[i].end) {
                        wordElements[i].classList.add('highlight-word');
                        break;
                    }
                }
            };
            utterance.onstart = () => { audioState = 'playing'; playIcon.classList.add('hidden'); pauseIcon.classList.remove('hidden'); audioStatus.textContent = "ƒêang ph√°t..."; };
            utterance.onend = () => {
                if (!isPausedByUser) {
                    lastSpokenCharIndex = 0;
                    audioState = 'idle';
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    audioStatus.textContent = "Nghe l·∫°i";
                    Array.from(optionsContainer.children).forEach(button => { button.disabled = false; button.classList.remove('opacity-50', 'cursor-not-allowed'); });
                    wordElements.forEach(el => el.classList.remove('highlight-word'));
                }
            };
            utterance.onerror = (e) => { audioState = 'idle'; audioStatus.textContent = "L·ªói ph√°t √¢m thanh"; console.error("SpeechSynthesis Error:", e); };
            synth.speak(utterance);
        }

        function setupAudioPlayer() {
            audioState = 'idle';
            lastSpokenCharIndex = 0;
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            audioStatus.textContent = "Nh·∫•n ƒë·ªÉ nghe";
            playAudioBtn.disabled = false;
        }

        function renderQuestion() {
            feedbackContainer.innerHTML = '';
            feedbackContainer.className = 'mt-6 p-4 rounded-lg min-h-[100px]';
            nextQuestionButton.classList.add('hidden');
            const questions = quizData.quizType === 'reading' || quizData.quizType === 'listening' ? quizData.raw.questions : quizData.raw;
            const currentQuestion = questions[currentQuestionIndex];
            
            questionText.textContent = currentQuestion.question;
            optionsContainer.innerHTML = '';

            const questionType = currentQuestion.type || 'multiple_choice';

            if (questionType === 'multiple_choice') {
                optionsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
                const shuffledOptions = [...currentQuestion.options].sort(() => Math.random() - 0.5);
                shuffledOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.className = "w-full text-left p-4 border-2 border-slate-300 rounded-lg hover:bg-slate-100 hover:border-sky-400 transition text-lg flex items-center justify-between";
                    const optionText = document.createElement('span');
                    optionText.textContent = option;
                    const infoBtn = document.createElement('i');
                    infoBtn.className = 'info-icon';
                    infoBtn.textContent = 'i';
                    infoBtn.title = `D·ªãch nghƒ©a "${option}"`;
                    infoBtn.onclick = (e) => { e.stopPropagation(); showTranslationModal(getTranslation(option)); };
                    button.appendChild(optionText);
                    button.appendChild(infoBtn);
                    button.onclick = () => handleAnswer(option);
                    if (quizData.quizType === 'listening') { button.disabled = true; button.classList.add('opacity-50', 'cursor-not-allowed'); }
                    optionsContainer.appendChild(button);
                });
            } else { 
                optionsContainer.className = 'flex flex-col items-center gap-4';
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'w-full md:w-3/4 p-3 border border-slate-400 rounded-lg text-lg text-center focus:ring-2 focus:ring-sky-500';
                input.placeholder = 'Nh·∫≠p c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n...';
                input.onkeydown = (e) => { if (e.key === 'Enter') checkAnswerBtn.click(); };
                
                const checkAnswerBtn = document.createElement('button');
                checkAnswerBtn.textContent = 'Ki·ªÉm tra';
                checkAnswerBtn.className = 'w-full md:w-3/4 bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-4 rounded-lg text-lg';
                checkAnswerBtn.onclick = () => {
                    handleAnswer(input.value);
                    input.disabled = true;
                    checkAnswerBtn.disabled = true;
                    checkAnswerBtn.classList.add('opacity-70');
                };
                optionsContainer.appendChild(input);
                optionsContainer.appendChild(checkAnswerBtn);
            }
        }

        function handleAnswer(selectedOption) {
            const questions = quizData.quizType === 'reading' || quizData.quizType === 'listening' ? quizData.raw.questions : quizData.raw;
            const currentQuestion = questions[currentQuestionIndex];
            const questionType = currentQuestion.type || 'multiple_choice';
            
            let isCorrect;
            if (questionType === 'multiple_choice') {
                isCorrect = selectedOption === currentQuestion.answer;
                Array.from(optionsContainer.children).forEach(button => {
                    button.disabled = true; button.classList.add('opacity-70');
                    if (button.querySelector('span').textContent === currentQuestion.answer) button.className = "w-full text-left p-4 border-2 border-green-500 bg-green-100 rounded-lg text-lg flex items-center justify-between font-semibold";
                    else if (button.querySelector('span').textContent === selectedOption) button.className = "w-full text-left p-4 border-2 border-red-500 bg-red-100 rounded-lg text-lg flex items-center justify-between";
                });
            } else {
                isCorrect = selectedOption.trim().toLowerCase() === currentQuestion.answer.toLowerCase();
            }

            if (isCorrect) {
                score++;
                feedbackContainer.className = 'mt-6 p-4 rounded-lg bg-green-100 text-green-800';
                feedbackContainer.innerHTML = `<b class="font-bold">Ch√≠nh x√°c!</b><p>${currentQuestion.explanation}</p>`;
            } else {
                feedbackContainer.className = 'mt-6 p-4 rounded-lg bg-red-100 text-red-800';
                const displayAnswer = questionType === 'multiple_choice' ? `<b>"${currentQuestion.answer}"</b>` : `ƒê√°p √°n ƒë√∫ng l√† <b>"${currentQuestion.answer}"</b>.`;
                feedbackContainer.innerHTML = `<b class="font-bold">Ch∆∞a ƒë√∫ng.</b> ${displayAnswer} <p>${currentQuestion.explanation}</p>`;
            }
            scoreEl.textContent = `ƒêi·ªÉm: ${score}`;
            nextQuestionButton.classList.remove('hidden');
        }

        function moveToNextQuestion() {
            if (synth.speaking) synth.cancel();
            currentQuestionIndex++;
            const questions = quizData.quizType === 'reading' || quizData.quizType === 'listening' ? quizData.raw.questions : quizData.raw;
            const total = questions.length;
            if (currentQuestionIndex < total) {
                progress.textContent = `C√¢u ${currentQuestionIndex + 1} / ${total}`;
                progressBar.style.width = `${((currentQuestionIndex + 1) / total) * 100}%`;
                if (quizData.quizType === 'listening') setupAudioPlayer();
                renderQuestion();
            } else {
                showResult();
            }
        }

        async function showResult() {
            const questions = quizData.quizType === 'reading' || quizData.quizType === 'listening' ? quizData.raw.questions : quizData.raw;
            const total = questions.length;
            if (auth.currentUser) {
                await updateUserStreak(auth.currentUser.uid);
                try {
                    const newResult = { userId: auth.currentUser.uid, topic: quizData.topic, level: quizData.level, type: quizData.quizType, vocabMode: quizData.vocabMode, score: score, totalQuestions: total, createdAt: new Date() };
                    allUserResults.push(newResult);
                    await addDoc(collection(db, "quizResults"), { ...newResult, createdAt: serverTimestamp() });
                } catch (e) { console.error("L·ªói khi l∆∞u k·∫øt qu·∫£: ", e); }
            }
            finalScore.textContent = `${score} / ${total}`;
            const percentage = (score / total) * 100;
            if (percentage === 100) resultMessage.textContent = "Tuy·ªát v·ªùi! B·∫°n ƒë√£ tr·∫£ l·ªùi ƒë√∫ng t·∫•t c·∫£!";
            else if (percentage >= 70) resultMessage.textContent = "L√†m t·ªët l·∫Øm! Ki·∫øn th·ª©c c·ªßa b·∫°n r·∫•t ·ªïn.";
            else if (percentage >= 40) resultMessage.textContent = "Kh√° l·∫Øm! Ti·∫øp t·ª•c luy·ªán t·∫≠p nh√©.";
            else resultMessage.textContent = "ƒê·ª´ng n·∫£n l√≤ng! M·ªói l·∫ßn luy·ªán t·∫≠p l√† m·ªôt b∆∞·ªõc ti·∫øn.";
            showView('result-view');
        }

        function calculateStats(results) {
            let totalCorrect = 0, totalQuestions = 0;
            const skillStats = { vocabulary: {c:0, t:0}, reading: {c:0, t:0}, grammar: {c:0, t:0}, listening: {c:0, t:0} };
            const topicStats = {};
            results.forEach(res => {
                totalCorrect += res.score; totalQuestions += res.totalQuestions;
                if (skillStats[res.type]) { skillStats[res.type].c += res.score; skillStats[res.type].t += res.totalQuestions; }
                if (res.type !== 'grammar') { if (!topicStats[res.topic]) topicStats[res.topic] = {c:0, t:0}; topicStats[res.topic].c += res.score; topicStats[res.topic].t += res.totalQuestions; }
            });
            return { totalCorrect, totalQuestions, skillStats, topicStats };
        }
        function displayHistoryStats(stats) {
            const { totalCorrect, totalQuestions, skillStats, topicStats } = stats;
            const overallRate = totalQuestions > 0 ? Math.round((totalCorrect / totalQuestions) * 100) : 0;
            const findBest = (s) => Object.entries(s).filter(([, v]) => v.t > 0).reduce((b, [k, v]) => (v.c / v.t > b.rate ? { key: k, rate: v.c / v.t } : b), { key: 'N/A', rate: -1 });
            const bestSkill = findBest(skillStats);
            const bestTopic = findBest(topicStats);
            const typeMap = { vocabulary: 'T·ª´ v·ª±ng', reading: 'ƒê·ªçc hi·ªÉu', grammar: 'Ng·ªØ ph√°p', listening: 'Nghe hi·ªÉu' };
            historyDashboard.innerHTML = `
                <div class="bg-blue-100 p-4 rounded-lg"><div class="text-sm text-blue-600 font-semibold">T·ª∑ l·ªá ƒë√∫ng</div><div class="text-3xl font-bold text-blue-800">${overallRate}%</div></div>
                <div class="bg-green-100 p-4 rounded-lg"><div class="text-sm text-green-600 font-semibold">K·ªπ nƒÉng t·ªët nh·∫•t</div><div class="text-2xl font-bold text-green-800 capitalize">${typeMap[bestSkill.key] || 'Ch∆∞a c√≥'}</div></div>
                <div class="bg-purple-100 p-4 rounded-lg"><div class="text-sm text-purple-600 font-semibold">Ch·ªß ƒë·ªÅ t·ªët nh·∫•t</div><div class="text-2xl font-bold text-purple-800 capitalize">${bestTopic.key}</div></div>`;
        }
        function generateRecommendations(stats) {
            const { skillStats } = stats;
            const recommendations = [];
            const findWorst = (s) => Object.entries(s).filter(([, v]) => v.t > 2).reduce((w, [k, v]) => (v.c / v.t < w.rate ? { key: k, rate: v.c / v.t } : w), { key: 'N/A', rate: 2 });
            const worstSkill = findWorst(skillStats);
            const typeMap = { vocabulary: 'T·ª´ v·ª±ng', reading: 'ƒê·ªçc hi·ªÉu', grammar: 'Ng·ªØ ph√°p', listening: 'Nghe hi·ªÉu' };
            if (worstSkill.key !== 'N/A' && worstSkill.rate < 0.7) {
                recommendations.push({ text: `C√≥ v·∫ª b·∫°n c·∫ßn c·∫£i thi·ªán k·ªπ nƒÉng <b>${typeMap[worstSkill.key]}</b>. Th·ª≠ m·ªôt b√†i ngay?`, settings: { type: worstSkill.key, level: 'B1', topic: 'General' } });
            }
            const findBest = (s) => Object.entries(s).filter(([, v]) => v.t > 2).reduce((b, [k, v]) => (v.c / v.t > b.rate ? { key: k, rate: v.c / v.t } : b), { key: 'N/A', rate: -1 });
            const bestSkill = findBest(skillStats);
            const levelOrder = ['A2', 'B1', 'B2', 'C1'];
            if (bestSkill.key !== 'N/A' && bestSkill.rate > 0.8) {
                const currentLevelIndex = levelOrder.indexOf('B1'); // Assume current level for now
                if (currentLevelIndex < levelOrder.length - 1) {
                    const nextLevel = levelOrder[currentLevelIndex + 1];
                    recommendations.push({ text: `B·∫°n l√†m r·∫•t t·ªët <b>${typeMap[bestSkill.key]}</b>! Th·ª≠ s·ª©c ·ªü tr√¨nh ƒë·ªô <b>${nextLevel}</b> nh√©?`, settings: { type: bestSkill.key, level: nextLevel, topic: 'General' } });
                }
            }
            if (recommendations.length === 0 && allUserResults.length > 0) {
                recommendations.push({ text: "B·∫°n ƒëang l√†m r·∫•t t·ªët! H√£y ti·∫øp t·ª•c ph√°t huy nh√©!", settings: null });
            }
            recommendationsContainer.innerHTML = recommendations.length > 0 ? `<h3 class="text-lg font-bold text-slate-700 mb-2">G·ª£i √Ω cho b·∫°n</h3>` : '';
            recommendations.forEach(rec => {
                const recButton = document.createElement('button');
                recButton.innerHTML = rec.text;
                recButton.className = "w-full text-left p-3 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg hover:bg-yellow-200 transition mb-2";
                if (rec.settings) { recButton.onclick = () => startQuiz(rec.settings); } 
                else { recButton.disabled = true; }
                recommendationsContainer.appendChild(recButton);
            });
        }
        function renderHistoryList() {
            const skill = filterSkill.value;
            const level = filterLevel.value;
            const filteredResults = allUserResults.filter(res => (skill === 'all' || res.type === skill) && (level === 'all' || res.level === level));
            if (filteredResults.length === 0) { historyList.innerHTML = '<p class="text-center text-slate-500">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.</p>'; return; }
            historyList.innerHTML = '';
            filteredResults.sort((a,b) => (b.createdAt?.seconds || b.createdAt) - (a.createdAt?.seconds || a.createdAt)).forEach(data => {
                const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleString('vi-VN') : new Date().toLocaleString('vi-VN');
                const typeText = data.type === 'reading' ? 'ƒê·ªçc hi·ªÉu' : (data.type === 'grammar' ? 'Ng·ªØ ph√°p' : (data.type === 'listening' ? 'Nghe hi·ªÉu' : 'T·ª´ v·ª±ng'));
                const topicText = data.type !== 'grammar' ? `<p class="font-bold text-base text-slate-800 capitalize">${data.topic} <span class="text-sm font-normal text-indigo-600">(${typeText})</span></p>` : `<p class="font-bold text-base text-slate-800 capitalize">${typeText}</p>`;
                historyList.innerHTML += `<div class="bg-slate-50 p-3 rounded-lg border border-slate-200"><div class="flex justify-between items-center"><div>${topicText}<div class="text-xs text-slate-500 mt-1"><span>Tr√¨nh ƒë·ªô: ${data.level.toUpperCase()}</span> | <span>${date}</span></div></div><div class="flex items-center space-x-3"><p class="font-bold text-xl ${data.score / data.totalQuestions >= 0.7 ? 'text-green-600' : 'text-orange-500'}">${data.score}/${data.totalQuestions}</p><button class="retry-button bg-sky-500 hover:bg-sky-600 text-white text-xs font-bold py-1 px-3 rounded-full" data-type="${data.type}" data-topic="${data.topic || ''}" data-level="${data.level}">L√†m l·∫°i</button></div></div></div>`;
            });
            document.querySelectorAll('.retry-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const { type, topic, level } = e.target.dataset;
                    startQuiz({ type, topic, level });
                });
            });
        }
        async function showHistory() {
            if (!auth.currentUser) { showError("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem l·ªãch s·ª≠."); return; }
            showView('history-view');
            historyList.innerHTML = '<div class="spinner mx-auto"></div>';
            historyDashboard.innerHTML = '';
            recommendationsContainer.innerHTML = '';
            try {
                if (allUserResults.length === 0) {
                    const q = query(collection(db, "quizResults"), where("userId", "==", auth.currentUser.uid));
                    const querySnapshot = await getDocs(q);
                    allUserResults = querySnapshot.docs.map(doc => doc.data());
                }
                if (allUserResults.length === 0) { historyList.innerHTML = '<p class="text-center text-slate-500">B·∫°n ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i n√†o.</p>'; return; }
                const stats = calculateStats(allUserResults);
                displayHistoryStats(stats);
                generateRecommendations(stats);
                renderHistoryList();
            } catch (error) {
                console.error("L·ªói khi t·∫£i l·ªãch s·ª≠: ", error);
                historyList.innerHTML = '<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠.</p>';
            }
        }
        
        function handleQuizTypeChange() {
            const selectedType = quizTypeSelect.value;
            const isVocab = selectedType === 'vocabulary';
            const isTopicBased = isVocab || selectedType === 'reading' || selectedType === 'listening';
            
            vocabModeContainer.style.maxHeight = isVocab ? '100px' : '0';
            vocabModeContainer.style.opacity = isVocab ? '1' : '0';
            vocabModeContainer.style.marginTop = isVocab ? '1.5rem' : '0';
            
            if (!isTopicBased) {
                topicContainer.style.maxHeight = '0'; topicContainer.style.opacity = '0';
                topicContainer.style.overflow = 'hidden'; topicContainer.style.marginTop = '0';
            } else {
                topicContainer.style.maxHeight = '100px'; topicContainer.style.opacity = '1';
                topicContainer.style.overflow = 'visible'; topicContainer.style.marginTop = '1.5rem';
            }
        }

        loginButton.addEventListener('click', () => handleAuthAction('login'));
        registerButton.addEventListener('click', () => handleAuthAction('register'));
        logoutButton.addEventListener('click', handleLogout);
        startQuizButton.addEventListener('click', () => startQuiz());
        playAgainButton.addEventListener('click', () => showView('setup-view'));
        backToSetupButton.addEventListener('click', () => showView('setup-view'));
        showHistoryButton.addEventListener('click', showHistory);
        backToSetupFromHistory.addEventListener('click', () => showView('setup-view'));
        viewHistoryFromResultButton.addEventListener('click', showHistory);
        nextQuestionButton.addEventListener('click', moveToNextQuestion);
        quizTypeSelect.addEventListener('change', handleQuizTypeChange);
        translateQuestionBtn.addEventListener('click', () => showTranslationModal(getTranslation(questionText.textContent)));
        closeTranslationModal.addEventListener('click', () => translationModal.classList.add('hidden'));
        translationModal.addEventListener('click', (e) => { if (e.target === translationModal) { translationModal.classList.add('hidden'); } });
        filterSkill.addEventListener('change', renderHistoryList);
        filterLevel.addEventListener('change', renderHistoryList);
        
        playAudioBtn.addEventListener('click', () => {
            if (audioState === 'playing') {
                isPausedByUser = true;
                synth.cancel();
                audioState = 'paused';
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                audioStatus.textContent = "ƒê√£ t·∫°m d·ª´ng";
            } else { 
                playSpeech(quizData.raw.script, lastSpokenCharIndex);
            }
        });
        
        showTranscriptBtn.addEventListener('click', () => {
            const isHidden = transcriptContainer.classList.toggle('hidden');
            showTranscriptBtn.textContent = isHidden ? 'Hi·ªán l·ªùi tho·∫°i' : '·∫®n l·ªùi tho·∫°i';
        });
    </script>
</body>
</html>
